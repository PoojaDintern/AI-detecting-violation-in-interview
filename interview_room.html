<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Interview Room ‚Äî RecruitAI</title>
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700;800&family=DM+Sans:wght@300;400;500;600&family=Plus+Jakarta+Sans:wght@700;800&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0f1117;
  --bg2: #161b27;
  --s: #1a2035;
  --s2: #1e2640;
  --border: #2a3350;
  --border2: #334066;
  --accent: #4f8ef7;
  --accent2: #6aa3ff;
  --accent-light: rgba(79,142,247,0.12);
  --accent-glow: rgba(79,142,247,0.2);
  --green: #10b981;
  --red: #ef4444;
  --yellow: #f59e0b;
  --text: #e8edf5;
  --text2: #c5cde0;
  --muted: #7a88a8;
  --shadow: 0 1px 3px rgba(0,0,0,0.4), 0 4px 12px rgba(0,0,0,0.3);
  --shadow-lg: 0 4px 20px rgba(0,0,0,0.5), 0 12px 40px rgba(0,0,0,0.4);
}
:root {
  --bg: #0f1117;
  --bg2: #161b27;
  --s: #1a2035;
  --s2: #1e2640;
  --border: #2a3350;
  --border2: #334066;
  --accent: #4f8ef7;
  --accent2: #6aa3ff;
  --accent-light: rgba(79,142,247,0.12);
  --accent-glow: rgba(79,142,247,0.2);
  --green: #10b981;
  --red: #ef4444;
  --yellow: #f59e0b;
  --text: #e8edf5;
  --text2: #c5cde0;
  --muted: #7a88a8;
  --shadow: 0 1px 3px rgba(0,0,0,0.4), 0 4px 12px rgba(0,0,0,0.3);
  --shadow-lg: 0 4px 20px rgba(0,0,0,0.5), 0 12px 40px rgba(0,0,0,0.4);
}

*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'DM Sans', sans-serif;background:var(--bg);color:var(--text);min-height:100vh;}
.topbar{background:var(--s);border-bottom:1px solid var(--border);padding:0 28px;height:60px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:200;}
.brand{font-family:'Plus Jakarta Sans','Playfair Display',sans-serif;font-size:18px;font-weight:800;background:linear-gradient(135deg,#fff,var(--accent2));background-clip:text;-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.topbar-right{display:flex;align-items:center;gap:16px;}
.timer-display{font-family:monospace;font-size:20px;font-weight:700;color:var(--accent2);background:var(--s2);padding:6px 14px;border-radius:8px;border:1px solid var(--border);}
.timer-display.warn{color:var(--red);border-color:var(--red);animation:pulse 1s infinite;}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.6}}
.layout{display:grid;grid-template-columns:1fr 300px;gap:0;min-height:calc(100vh - 60px);}
.interview-area{padding:28px;overflow-y:auto;}
.proctoring-sidebar{background:var(--s);border-left:1px solid var(--border);padding:20px;display:flex;flex-direction:column;gap:16px;position:sticky;top:60px;height:calc(100vh - 60px);overflow-y:auto;}
#mode-selector{max-width:680px;margin:0 auto;}
.mode-header{text-align:center;margin-bottom:32px;}
.mode-header h1{font-family:'Playfair Display', serif;font-size:32px;font-weight:800;margin-bottom:8px;}
.mode-header p{color:var(--muted);font-size:15px;}
.room-join{background:var(--s);border:1px solid var(--border);border-radius:14px;padding:24px;margin-bottom:20px;}
.room-join label{display:block;font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.05em;margin-bottom:8px;font-weight:600;}
.room-join input,.room-join select{width:100%;padding:12px 14px;background:var(--s2);border:1px solid var(--border);border-radius:9px;color:var(--text);font-size:14px;font-family:'DM Sans', sans-serif;outline:none;margin-bottom:14px;}
.room-join input:focus,.room-join select:focus{border-color:var(--accent);}
.btn-start{width:100%;padding:15px;background:linear-gradient(135deg,var(--accent),#162d50);border:none;border-radius:11px;color:#fff;font-size:16px;font-weight:700;cursor:pointer;font-family:'Playfair Display', serif;transition:all .25s;}
.btn-start:hover{transform:translateY(-2px);box-shadow:0 12px 28px rgba(13,31,60,0.3);}
#mcq-area{display:none;}
.q-progress{display:flex;align-items:center;gap:12px;margin-bottom:28px;}
.q-dots{display:flex;gap:6px;flex-wrap:wrap;}
.qdot{width:14px;height:14px;border-radius:50%;background:var(--s2);border:2px solid var(--border);cursor:pointer;transition:all .2s;}
.qdot.ans{background:var(--accent);border-color:var(--accent);}
.qdot.curr{background:transparent;border-color:var(--accent2);}
.question-card{background:var(--s);border:1px solid var(--border);border-radius:16px;padding:32px;margin-bottom:20px;}
.q-num{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;margin-bottom:12px;font-family:'Playfair Display', serif;font-weight:700;}
.q-text{font-size:19px;font-weight:500;line-height:1.55;margin-bottom:24px;}
.options{display:grid;gap:10px;}
.opt{display:flex;align-items:center;gap:14px;padding:15px 18px;background:var(--s2);border:2px solid var(--border);border-radius:11px;cursor:pointer;transition:all .2s;font-size:14px;}
.opt:hover{border-color:var(--accent);background:rgba(79,142,247,.1);}
.opt.selected{border-color:var(--accent);background:rgba(79,142,247,.1);}
.opt-letter{width:30px;height:30px;border-radius:8px;background:var(--s);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:13px;flex-shrink:0;transition:all .2s;}
.opt.selected .opt-letter{background:var(--accent);border-color:var(--accent);color:#fff;}
.q-nav{display:flex;justify-content:space-between;align-items:center;}
.btn-nav{padding:10px 22px;border:1px solid var(--border);border-radius:9px;background:var(--s2);color:var(--text);cursor:pointer;font-size:14px;font-weight:600;font-family:'DM Sans', sans-serif;transition:all .2s;}
.btn-nav:hover{border-color:var(--accent);color:var(--accent2);}
.btn-submit-mcq{padding:12px 28px;background:linear-gradient(135deg,var(--green),#34d399);border:none;border-radius:9px;color:#fff;font-size:15px;font-weight:700;cursor:pointer;font-family:'DM Sans', sans-serif;}
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   AI INTERVIEWER  ¬∑  Professional Video Call UI
   (Teams / Meet style ‚Äî clean, industry-standard)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
#ai-area { display: none; }

/* ‚îÄ‚îÄ Outer video call frame ‚îÄ‚îÄ */
.ai-video-call {
  position: relative;
  width: 100%; aspect-ratio: 16/9; max-height: 420px;
  border-radius: 16px; overflow: hidden;
  background: #1c2333;
  box-shadow: 0 8px 40px rgba(0,0,0,0.55), 0 0 0 1px rgba(255,255,255,0.07);
  margin-bottom: 14px;
}

/* ‚îÄ‚îÄ Background: subtle bokeh / blurred office ‚îÄ‚îÄ */
.ai-bg {
  position: absolute; inset: 0;
  background:
    radial-gradient(ellipse 60% 70% at 30% 40%, #1e3a5f 0%, transparent 65%),
    radial-gradient(ellipse 50% 60% at 75% 60%, #0f2a3f 0%, transparent 65%),
    linear-gradient(160deg, #111927 0%, #1a2640 50%, #0d1520 100%);
}
/* Faint bokeh circles ‚Äî blurred office lights */
.ai-bg::before {
  content: '';
  position: absolute; inset: 0;
  background:
    radial-gradient(circle 80px at 15% 25%, rgba(100,160,255,0.08) 0%, transparent 100%),
    radial-gradient(circle 120px at 80% 20%, rgba(255,200,100,0.06) 0%, transparent 100%),
    radial-gradient(circle 60px at 65% 75%, rgba(80,140,255,0.06) 0%, transparent 100%),
    radial-gradient(circle 90px at 10% 80%, rgba(60,100,200,0.05) 0%, transparent 100%);
}
/* Subtle grid texture on bg */
.ai-bg::after {
  content: '';
  position: absolute; inset: 0;
  background-image: linear-gradient(rgba(255,255,255,0.015) 1px, transparent 1px),
                    linear-gradient(90deg, rgba(255,255,255,0.015) 1px, transparent 1px);
  background-size: 40px 40px;
}

/* ‚îÄ‚îÄ Central avatar area ‚îÄ‚îÄ */
.ai-center {
  position: absolute; inset: 0;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  gap: 0;
}

/* ‚îÄ‚îÄ Avatar image wrap ‚îÄ‚îÄ */
.ai-avatar-circle-wrap {
  position: relative;
  display: flex; align-items: flex-end; justify-content: center;
}

/* Animated speaking ring ‚Äî 3 layers (around image) */
.ai-speak-ring {
  position: absolute;
  border-radius: 50%;
  border: 2.5px solid transparent;
  opacity: 0;
  transition: opacity 0.3s;
  /* rings centered on the head area (top portion of image) */
  width: clamp(110px, 22vw, 160px);
  height: clamp(110px, 22vw, 160px);
  top: 0; left: 50%; transform: translateX(-50%);
}
.ai-speak-ring-1 { border-color: rgba(79,142,247,0.85); inset: unset; top: -6px; width: calc(clamp(110px, 22vw, 160px) + 12px); height: calc(clamp(110px, 22vw, 160px) + 12px); }
.ai-speak-ring-2 { border-color: rgba(79,142,247,0.4);  inset: unset; top: -14px; width: calc(clamp(110px, 22vw, 160px) + 28px); height: calc(clamp(110px, 22vw, 160px) + 28px); }
.ai-speak-ring-3 { border-color: rgba(79,142,247,0.15); inset: unset; top: -22px; width: calc(clamp(110px, 22vw, 160px) + 44px); height: calc(clamp(110px, 22vw, 160px) + 44px); }

.ai-video-call.speaking .ai-speak-ring-1 { opacity: 1; animation: speakPulse1 1.1s ease-in-out infinite; }
.ai-video-call.speaking .ai-speak-ring-2 { opacity: 1; animation: speakPulse2 1.1s ease-in-out infinite 0.15s; }
.ai-video-call.speaking .ai-speak-ring-3 { opacity: 1; animation: speakPulse2 1.1s ease-in-out infinite 0.3s; }

@keyframes speakPulse1 {
  0%,100% { transform: translateX(-50%) scale(1);    border-color: rgba(79,142,247,0.85); }
  50%      { transform: translateX(-50%) scale(1.04); border-color: rgba(79,142,247,1); }
}
@keyframes speakPulse2 {
  0%,100% { transform: translateX(-50%) scale(1);    opacity: 0.5; }
  50%      { transform: translateX(-50%) scale(1.07); opacity: 1;   }
}

/* Avatar image */
.ai-avatar-img-wrap {
  position: relative; z-index: 5;
  width: clamp(160px, 30vw, 260px);
  filter: drop-shadow(0 8px 32px rgba(0,0,0,0.55));
  /* idle breathing animation */
  animation: avatarBreathe 4s ease-in-out infinite;
}
.ai-avatar-img-wrap.talking {
  animation: avatarTalk 0.35s ease-in-out infinite alternate;
}
@keyframes avatarBreathe {
  0%,100% { transform: translateY(0px) scale(1); }
  50%      { transform: translateY(-4px) scale(1.005); }
}
@keyframes avatarTalk {
  0%   { transform: translateY(-2px) rotate(-0.4deg); }
  100% { transform: translateY(0px)  rotate(0.4deg);  }
}

.ai-avatar-img {
  width: 100%; height: auto;
  display: block;
  /* remove white bg from the image */
  mix-blend-mode: normal;
}

/* AI label under avatar */
.ai-label-under {
  margin-top: 14px;
  text-align: center;
}
.ai-label-name {
  font-size: 15px; font-weight: 600; color: #fff;
  letter-spacing: 0.01em;
}
.ai-label-role {
  font-size: 11px; color: rgba(255,255,255,0.45);
  margin-top: 3px; font-weight: 400;
  text-transform: uppercase; letter-spacing: 0.08em;
}

/* ‚îÄ‚îÄ Top bar (call controls row) ‚îÄ‚îÄ */
.ai-call-topbar {
  position: absolute; top: 0; left: 0; right: 0; z-index: 30;
  padding: 12px 16px;
  background: linear-gradient(180deg, rgba(0,0,0,0.6) 0%, transparent 100%);
  display: flex; align-items: center; justify-content: space-between;
}
.ai-call-label {
  display: flex; align-items: center; gap: 8px;
  font-size: 12px; font-weight: 600; color: rgba(255,255,255,0.9);
}
.ai-live-dot {
  width: 7px; height: 7px; border-radius: 50%;
  background: #22c55e;
  box-shadow: 0 0 0 2px rgba(34,197,94,0.25);
  animation: livePulse 2.5s ease-in-out infinite;
}
@keyframes livePulse {
  0%,100% { box-shadow: 0 0 0 2px rgba(34,197,94,0.25); }
  50%      { box-shadow: 0 0 0 5px rgba(34,197,94,0.1);  }
}
.ai-call-timer {
  font-family: 'DM Mono', monospace;
  font-size: 12px; color: rgba(255,255,255,0.5);
  background: rgba(0,0,0,0.35);
  padding: 3px 10px; border-radius: 20px;
  letter-spacing: 0.05em;
}

/* ‚îÄ‚îÄ Bottom bar ‚îÄ‚îÄ */
.ai-call-bottombar {
  position: absolute; bottom: 0; left: 0; right: 0; z-index: 30;
  padding: 32px 16px 14px;
  background: linear-gradient(0deg, rgba(0,0,0,0.65) 0%, transparent 100%);
  display: flex; align-items: flex-end; justify-content: space-between;
}
.ai-name-tag {
  display: flex; align-items: center; gap: 8px;
  font-size: 13px; font-weight: 600; color: #fff;
}
.ai-mic-icon {
  width: 22px; height: 22px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 11px;
  background: rgba(255,255,255,0.1);
  border: 1px solid rgba(255,255,255,0.15);
}
.ai-mic-icon.active { background: rgba(79,142,247,0.25); border-color: rgba(79,142,247,0.5); }

/* ‚îÄ‚îÄ Audio wave ‚îÄ‚îÄ */
.ai-audio-wave {
  display: flex; align-items: center; gap: 3px; height: 22px;
  opacity: 0; transition: opacity 0.3s;
}
.ai-audio-wave.active { opacity: 1; }
.wave-bar {
  width: 3px; border-radius: 3px;
  background: linear-gradient(180deg, #6aa3ff, #4f8ef7);
  animation: waveAnim 0.5s ease-in-out infinite alternate;
}
.wave-bar:nth-child(1){height:4px;animation-delay:0s}
.wave-bar:nth-child(2){height:10px;animation-delay:.06s}
.wave-bar:nth-child(3){height:18px;animation-delay:.12s}
.wave-bar:nth-child(4){height:14px;animation-delay:.18s}
.wave-bar:nth-child(5){height:8px;animation-delay:.24s}
.wave-bar:nth-child(6){height:16px;animation-delay:.30s}
.wave-bar:nth-child(7){height:11px;animation-delay:.36s}
.wave-bar:nth-child(8){height:5px;animation-delay:.42s}
@keyframes waveAnim { 0%{transform:scaleY(0.25)} 100%{transform:scaleY(1)} }

/* ‚îÄ‚îÄ Candidate PiP ‚îÄ‚îÄ */
.ai-candidate-pip {
  position: absolute; bottom: 14px; right: 14px;
  width: 22%; max-width: 130px; aspect-ratio: 4/3;
  border-radius: 10px; overflow: hidden;
  border: 2px solid rgba(255,255,255,0.15);
  background: #0a0a0f;
  box-shadow: 0 4px 16px rgba(0,0,0,0.6);
  z-index: 40;
}
.ai-candidate-pip video { width: 100%; height: 100%; object-fit: cover; }
.pip-label {
  position: absolute; bottom: 5px; left: 7px;
  font-size: 10px; font-weight: 600;
  color: rgba(255,255,255,0.88);
  background: rgba(0,0,0,0.6);
  padding: 2px 7px; border-radius: 4px;
}

/* ‚îÄ‚îÄ Status row below video ‚îÄ‚îÄ */
.ai-avatar-wrap { display: flex; flex-direction: column; align-items: center; margin-bottom: 0; }
.ai-status { font-size: 13px; color: var(--muted); margin-top: 8px; min-height: 20px; text-align: center; }

/* ‚îÄ‚îÄ Legacy ‚îÄ‚îÄ */
.ai-avatar, .ring, .ring2 { display: none; }
@keyframes ripple { 0%{transform:scale(1);opacity:1} 100%{transform:scale(1.2);opacity:0} }
/* Loading spinner shown while fetching questions */
.ai-loading{display:flex;flex-direction:column;align-items:center;gap:12px;padding:24px;background:var(--s);border:1px solid var(--border);border-radius:16px;margin-bottom:20px;}
.spinner{width:36px;height:36px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite;}

.ai-error-box{background:rgba(244,63,94,.08);border:1px solid rgba(244,63,94,.3);border-radius:12px;padding:18px;margin-bottom:20px;display:none;text-align:center;}
.ai-error-box h3{color:var(--red);margin-bottom:6px;font-size:15px;}
.ai-error-box p{color:var(--muted);font-size:13px;line-height:1.6;}
.btn-retry{margin-top:12px;padding:9px 20px;background:var(--red);border:none;border-radius:8px;color:#fff;font-weight:700;cursor:pointer;font-size:13px;}
.ai-question-box{background:var(--s);border:1px solid var(--border);border-radius:16px;padding:24px;margin-bottom:20px;min-height:100px;position:relative;}
.ai-question-text{font-size:18px;line-height:1.6;font-weight:500;}
.ai-question-text .cursor{display:inline-block;width:3px;height:20px;background:var(--accent);margin-left:2px;animation:blink .6s step-end infinite;vertical-align:middle;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0}}
.ai-q-num{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;margin-bottom:10px;}
.answer-area{position:relative;}
.answer-textarea{width:100%;min-height:120px;padding:16px;background:var(--s2);border:1px solid var(--border);border-radius:12px;color:var(--text);font-size:15px;font-family:'DM Sans', sans-serif;resize:vertical;outline:none;line-height:1.6;transition:border-color .2s;}
.answer-textarea:focus{border-color:var(--accent);}
.answer-controls{display:flex;justify-content:space-between;align-items:center;margin-top:12px;flex-wrap:wrap;gap:10px;}
.btn-voice{display:flex;align-items:center;gap:8px;padding:10px 18px;background:var(--s2);border:1px solid var(--border);border-radius:9px;color:var(--text);cursor:pointer;font-size:13px;font-weight:600;transition:all .2s;}
.btn-voice.recording{background:rgba(244,63,94,.15);border-color:rgba(244,63,94,.4);color:var(--red);}
.btn-send{padding:11px 26px;background:linear-gradient(135deg,var(--accent),#162d50);border:none;border-radius:9px;color:#fff;font-size:14px;font-weight:600;cursor:pointer;font-family:'DM Sans', sans-serif;transition:opacity .2s;}
.btn-send:disabled{opacity:.45;cursor:not-allowed;}
.feedback-box{background:rgba(13,31,60,0.06);border:1px solid rgba(13,31,60,0.15);border-radius:12px;padding:16px;margin-top:14px;display:none;}
.fb-score{font-size:28px;font-weight:700;color:var(--accent2);margin-bottom:6px;}
.fb-text{font-size:13px;color:var(--muted);line-height:1.6;}
.progress-bar{height:5px;background:var(--border);border-radius:10px;overflow:hidden;margin:16px 0;}
.progress-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));transition:width .5s;}
#live-area{display:none;}
.video-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px;}
.video-box{background:#000;border-radius:14px;aspect-ratio:16/9;overflow:hidden;position:relative;border:1px solid var(--border);}
.video-box video{width:100%;height:100%;object-fit:cover;}
.video-label{position:absolute;bottom:10px;left:10px;background:rgba(0,0,0,.7);padding:4px 10px;border-radius:6px;font-size:12px;font-weight:600;}
.recruiter-msg-box{background:var(--s);border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:16px;max-height:160px;overflow-y:auto;}
.rmsg{padding:8px 12px;border-radius:8px;margin-bottom:8px;font-size:13px;}
.rmsg.recruiter{background:rgba(13,31,60,0.07);border:1px solid rgba(13,31,60,0.15);}
.rmsg-from{font-size:10px;color:var(--muted);margin-bottom:3px;font-weight:600;text-transform:uppercase;}
.cam-box{background:#000;border-radius:10px;aspect-ratio:4/3;overflow:hidden;position:relative;}
.cam-box video{width:100%;height:100%;object-fit:cover;}
.cam-overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:var(--muted);font-size:12px;}
.score-widget{background:var(--s2);border:1px solid var(--border);border-radius:12px;padding:16px;text-align:center;}
.score-big{font-family:'Playfair Display', serif;font-size:44px;font-weight:800;}
.score-lbl{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;margin-top:4px;}
.status-pill{display:flex;align-items:center;gap:8px;padding:8px 12px;border-radius:8px;font-size:12px;margin:4px 0;}
.status-pill.ok{background:rgba(16,185,129,.1);color:#6ee7b7;}
.status-pill.warn{background:rgba(245,158,11,.1);color:#fcd34d;}
.status-pill.bad{background:rgba(244,63,94,.1);color:#fda4af;}
.vio-log{font-size:11px;max-height:180px;overflow-y:auto;}
.vio-item{padding:6px 9px;background:rgba(244,63,94,.08);border-left:3px solid var(--red);border-radius:4px;margin-bottom:5px;color:#fda4af;}
.stats-mini{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
.sm{background:var(--s2);border-radius:8px;padding:10px;text-align:center;border:1px solid var(--border);}
.sm-val{font-size:22px;font-weight:700;font-family:'Playfair Display', serif;color:var(--accent2);}
.sm-lbl{font-size:10px;color:var(--muted);margin-top:3px;}
.fs-overlay{position:fixed;inset:0;background:rgba(0,0,0,.95);z-index:9999;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(12px);}
.fs-card{background:var(--s);border:1px solid var(--border);border-radius:20px;padding:48px;text-align:center;max-width:520px;}
.fs-card h2{font-family:'Playfair Display', serif;font-size:28px;font-weight:800;margin-bottom:12px;}
.fs-card p{color:var(--muted);margin-bottom:24px;font-size:15px;line-height:1.6;}
.fs-btn{padding:16px 40px;background:linear-gradient(135deg,var(--accent),#162d50);border:none;border-radius:12px;color:#fff;font-size:17px;font-weight:700;cursor:pointer;font-family:'Playfair Display', serif;box-shadow:0 8px 24px rgba(13,31,60,0.3);}

.brand { background: linear-gradient(135deg, var(--accent), var(--accent2)); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
.brand-name { color: var(--text); -webkit-text-fill-color: var(--text); }



/* Violation toast */
/* Subtle background texture */
body::before {
  content: '';
  position: fixed;
  inset: 0;
  background-image: radial-gradient(circle at 20% 20%, rgba(26,86,219,0.06) 0%, transparent 50%),
                    radial-gradient(circle at 80% 80%, rgba(37,99,235,0.04) 0%, transparent 50%);
  pointer-events: none;
  z-index: 0;
}

/* Cards elevated */
.card, .stat, .join-card, .result-header, .score-card, .modal-card {
  box-shadow: 0 1px 3px rgba(15,30,60,0.06), 0 4px 16px rgba(15,30,60,0.08);
  transition: box-shadow 0.2s ease;
}
.card:hover, .stat:hover {
  box-shadow: 0 2px 8px rgba(15,30,60,0.08), 0 8px 24px rgba(15,30,60,0.1);
}

/* Topbar elevated */
.topbar {
  box-shadow: 0 1px 0 var(--border), 0 2px 8px rgba(15,30,60,0.06);
  backdrop-filter: blur(10px);
}

/* Table styling */
table {
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 1px 3px rgba(15,30,60,0.06);
}

/* Stat top bar glow */
.stat.blue::before { background: linear-gradient(90deg, var(--accent), #4a6fa5); }
.stat.green::before { background: linear-gradient(90deg, var(--green), #34d399); }
.stat.yellow::before { background: linear-gradient(90deg, var(--yellow), #fbbf24); }
.stat.red::before { background: linear-gradient(90deg, var(--red), #fc8181); }
.stat.purple::before { background: linear-gradient(90deg, #7c3aed, #a78bfa); }
.stat.teal::before { background: linear-gradient(90deg, #0d9488, #2dd4bf); }

/* Proctoring sidebar brighter */
.proctoring-sidebar {
  background: var(--s);
  border-left: 1px solid var(--border);
}

/* Section titles */
.page-title, .card-title, .section-title, .join-title {
  color: var(--text);
  font-family: 'Playfair Display', serif;
}
.page-sub, .join-desc { color: var(--muted); }

/* Main wrapper bg */
.main, .container { position: relative; z-index: 1; }
.layout { position: relative; z-index: 1; }


/* Dark background with subtle gradient */
body {
  background: var(--bg);
  background-attachment: fixed;
  color: var(--text);
}

/* Subtle dark background decoration */
body::before {
  content: '';
  position: fixed;
  inset: 0;
  background-image: 
    radial-gradient(ellipse at 15% 25%, rgba(13,31,60,0.06) 0%, transparent 45%),
    radial-gradient(ellipse at 85% 75%, rgba(59,130,246,0.06) 0%, transparent 45%);
  pointer-events: none;
  z-index: 0;
}

/* Background grid - subtle on dark */
.bg-grid {
  background-image: linear-gradient(rgba(37,99,235,0.05) 1px, transparent 1px),
                    linear-gradient(90deg, rgba(37,99,235,0.05) 1px, transparent 1px);
}
.orb1 { background: rgba(37,99,235,0.10); }
.orb2 { background: rgba(59,130,246,0.07); }

/* handled via JS scoreColor function updates */


/* Dark scrollbar */
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:var(--bg2)}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:var(--muted)}
</style>
</head>
<body>

<!-- FULLSCREEN GATE -->
<div class="fs-overlay" id="fs-overlay">
  <div class="fs-card">
    <div style="font-size:60px;margin-bottom:16px;">üîí</div>
    <h2>Fullscreen Required</h2>
    <p>To maintain exam integrity, you must enter fullscreen mode. Your camera, gaze, and screen activity will be monitored throughout.</p>
    <button class="fs-btn" id="fs-btn">Enter Fullscreen & Continue</button>
  </div>
</div>

<div class="topbar">
  <div class="brand">ü§ñ RecruitAI ‚Äî Interview</div>
  <div class="topbar-right">
    <span style="font-size:13px;color:var(--muted)">Welcome, <strong id="user-name">‚Ä¶</strong></span>
    <div class="timer-display" id="timer">45:00</div>
  </div>
</div>

<div class="layout">
  <div class="interview-area">

    <!-- MODE SELECTOR -->
    <div id="mode-selector">
      <div class="mode-header">
        <h1>Join Your Interview</h1>
        <p>Enter your room code to join, or start a self-scheduled interview</p>
      </div>
      <div class="room-join">
        <label>Room Code (from recruiter)</label>
        <input type="text" id="room-code-input" placeholder="e.g. AB12CD34" maxlength="8" style="text-transform:uppercase;font-family:monospace;letter-spacing:.1em;font-size:18px;">
        <label>Job Role</label>
        <select id="role-select"><option value="">Loading‚Ä¶</option></select>
        <button class="btn-start" id="join-btn" onclick="joinOrStart()">üöÄ Join Interview</button>
      </div>
    </div>

    <!-- MCQ -->
    <div id="mcq-area">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;">
        <div>
          <div style="font-family:'Playfair Display', serif;font-size:22px;font-weight:800;" id="mcq-title">MCQ Assessment</div>
          <div style="font-size:13px;color:var(--muted);" id="mcq-subtitle">10 Questions ¬∑ Role-based</div>
        </div>
      </div>
      <div class="q-progress">
        <div class="q-dots" id="q-dots"></div>
        <div style="font-size:12px;color:var(--muted);margin-left:auto;" id="q-counter">0/10</div>
      </div>
      <div class="question-card" id="q-card">
        <div class="q-num" id="q-num">Question 1 of 10</div>
        <div class="q-text" id="q-text">Loading‚Ä¶</div>
        <div class="options" id="q-options"></div>
      </div>
      <div class="q-nav">
        <button class="btn-nav" id="btn-prev" onclick="navQ(-1)">‚Üê Previous</button>
        <div style="font-size:12px;color:var(--muted);" id="q-answered">0 answered</div>
        <button class="btn-nav" id="btn-next" onclick="navQ(1)">Next ‚Üí</button>
      </div>
      <div style="margin-top:20px;text-align:center;">
        <button class="btn-submit-mcq" onclick="confirmSubmitMCQ()">‚úÖ Submit Exam</button>
      </div>
    </div>

    <!-- AI INTERVIEWER ‚Äî Professional Video Call -->
    <div id="ai-area">

      <div class="ai-video-call" id="ai-video-call">

        <!-- Background -->
        <div class="ai-bg"></div>

        <!-- Central avatar -->
        <div class="ai-center">
          <div class="ai-avatar-circle-wrap">
            <div class="ai-speak-ring ai-speak-ring-3"></div>
            <div class="ai-speak-ring ai-speak-ring-2"></div>
            <div class="ai-speak-ring ai-speak-ring-1"></div>
            <div class="ai-avatar-img-wrap" id="ai-avatar-img-wrap">
              <img src="data:image/jpeg;base64,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" class="ai-avatar-img" id="ai-avatar-img" alt="Alex AI Interviewer"/>
            </div>
          </div>
          <div class="ai-label-under">
            <div class="ai-label-name">Alex</div>
            <div class="ai-label-role">AI Interviewer ¬∑ RecruitAI</div>
          </div>
        </div>

        <!-- Top bar -->
        <div class="ai-call-topbar">
          <div class="ai-call-label">
            <div class="ai-live-dot"></div>
            Interview in progress
          </div>
          <div class="ai-call-timer" id="ai-call-timer">00:00</div>
        </div>

        <!-- Bottom bar -->
        <div class="ai-call-bottombar">
          <div class="ai-name-tag">
            <div class="ai-mic-icon active" id="ai-mic-icon">üéô</div>
            Alex
          </div>
          <div class="ai-audio-wave" id="ai-audio-wave">
            <div class="wave-bar"></div><div class="wave-bar"></div>
            <div class="wave-bar"></div><div class="wave-bar"></div>
            <div class="wave-bar"></div><div class="wave-bar"></div>
            <div class="wave-bar"></div><div class="wave-bar"></div>
          </div>
        </div>

        <!-- Candidate PiP -->
        <div class="ai-candidate-pip">
          <video id="pip-cam" autoplay muted playsinline></video>
          <div class="pip-label">You</div>
        </div>

      </div>

      <!-- Status -->
      <div class="ai-avatar-wrap">
        <div class="ai-status" id="ai-status">Connecting to AI‚Ä¶</div>
      </div>

      <div class="progress-bar"><div class="progress-fill" id="ai-progress" style="width:0%"></div></div>

      <!-- Loading spinner shown while questions are being fetched -->
      <div class="ai-loading" id="ai-loading">
        <div class="spinner"></div>
        <div style="color:var(--muted);font-size:13px;">Alex is preparing your questions‚Ä¶</div>
        <div style="color:var(--muted);font-size:11px;margin-top:4px;" id="ai-load-detail">Connecting to AI engine‚Ä¶</div>
      </div>

      <!-- Error box shown if questions fail to load -->
      <div class="ai-error-box" id="ai-error-box">
        <h3>‚ö†Ô∏è Could not load AI questions</h3>
        <p id="ai-error-msg">The AI engine is not connected. Make sure your ANTHROPIC_API_KEY is set before starting the server. Falling back to standard questions‚Ä¶</p>
        <button class="btn-retry" onclick="retryLoadQuestions()">üîÑ Retry</button>
      </div>

      <div class="ai-question-box" id="ai-q-box" style="display:none;">
        <div class="ai-q-num" id="ai-q-num">Question 1 of 10</div>
        <div class="ai-question-text" id="ai-q-text"><span class="cursor"></span></div>
      </div>

      <div class="answer-area" id="ai-answer-area" style="display:none;">
        <textarea class="answer-textarea" id="ai-answer" placeholder="Type your answer here, or use the microphone‚Ä¶" rows="5"></textarea>
        <div class="answer-controls">
          <button class="btn-voice" id="voice-btn" onclick="toggleVoice()">üé§ Start Recording</button>
          <div style="font-size:12px;color:var(--muted);" id="ai-hint">Be specific and concise</div>
          <button class="btn-send" id="send-btn" onclick="submitAIAnswer()">Submit Answer ‚Üí</button>
        </div>
      </div>

      <div class="feedback-box" id="feedback-box">
        <div class="fb-score" id="fb-score">‚Äî</div>
        <div class="fb-text" id="fb-text"></div>
      </div>
    </div>

    <!-- LIVE RECRUITER -->
    <div id="live-area">
      <div style="font-family:'Playfair Display', serif;font-size:22px;font-weight:800;margin-bottom:16px;">üé• Live Interview</div>
      <div class="video-grid">
        <div class="video-box">
          <video id="local-video" autoplay muted playsinline></video>
          <div class="video-label">You</div>
        </div>
        <div class="video-box">
          <video id="remote-video" autoplay playsinline></video>
          <div class="video-label" style="background:rgba(0,0,0,0.7);">Recruiter</div>
        </div>
      </div>
      <div style="font-size:13px;color:var(--muted);margin-bottom:8px;">Messages from Recruiter:</div>
      <div class="recruiter-msg-box" id="recruiter-msgs">
        <div style="color:var(--muted);font-size:12px;text-align:center;">Waiting for recruiter to connect‚Ä¶</div>
      </div>
    </div>

  </div>

  <!-- PROCTORING SIDEBAR -->
  <div class="proctoring-sidebar">
    <div style="font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:.06em;color:var(--muted);">üõ°Ô∏è Proctoring</div>
    <div class="cam-box">
      <video id="proctor-cam" autoplay muted playsinline></video>
      <div class="cam-overlay" id="cam-status-overlay">Initializing‚Ä¶</div>
    </div>
    <div class="score-widget">
      <div class="score-big" id="cred-score">100</div>
      <div class="score-lbl">Credibility Score</div>
    </div>
    <div id="face-status" class="status-pill warn">‚ö†Ô∏è Initializing camera‚Ä¶</div>
    <div id="gaze-status" class="status-pill warn">üëÅÔ∏è Calibrating gaze‚Ä¶</div>
    <div id="device-status" class="status-pill ok">üì± No device detected</div>
    <div class="stats-mini">
      <div class="sm"><div class="sm-val" id="vio-count">0</div><div class="sm-lbl">Violations</div></div>
      <div class="sm"><div class="sm-val" id="gaze-count">0</div><div class="sm-lbl">Gaze Alerts</div></div>
    </div>
    <div style="font-size:11px;color:var(--muted);font-weight:600;text-transform:uppercase;letter-spacing:.05em;">Violation Log</div>
    <div class="vio-log" id="vio-log"><div style="color:var(--muted);font-size:11px;">No violations recorded</div></div>
  </div>
</div>


</div>

<script>
// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let currentUser=null, socket=null, sessionData=null, examStarted=false;
let camStream=null, peerConn=null, speechRec=null, isRecording=false;
let mcqQuestions=[], currentQ=0, mcqAnswers={};
let aiQuestions=[], aiCurrentQ=0, aiTranscript=[], aiTotalScore=0;
let examStartTime=Date.now(), timerInterval=null;
let violations=0, gazeAlerts=0;

// ‚îÄ‚îÄ FALLBACK QUESTIONS (used if API key is missing) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const FALLBACK_QUESTIONS = {
  default: [
    {id:1, question:"Tell me about yourself and your background in this field.", expected_keywords:["experience","skills","background"]},
    {id:2, question:"What are your strongest technical skills and how have you applied them?", expected_keywords:["technical","skills","project"]},
    {id:3, question:"Describe a challenging project you worked on and how you handled it.", expected_keywords:["challenge","solution","team"]},
    {id:4, question:"How do you approach debugging a complex problem you've never seen before?", expected_keywords:["debug","systematic","research","logs"]},
    {id:5, question:"What is the difference between synchronous and asynchronous programming?", expected_keywords:["sync","async","blocking","callback","promise"]},
    {id:6, question:"Explain how you would design a simple REST API for a user management system.", expected_keywords:["REST","endpoint","GET","POST","authentication"]},
    {id:7, question:"What is version control and why is it important in software development?", expected_keywords:["git","commit","branch","merge","collaboration"]},
    {id:8, question:"How do you ensure the quality of your code?", expected_keywords:["testing","review","unit test","documentation"]},
    {id:9, question:"Where do you see yourself professionally in the next 2-3 years?", expected_keywords:["growth","goals","learning","leadership"]},
    {id:10, question:"Do you have any questions for us about the role or the team?", expected_keywords:["team","culture","challenges","growth"]}
  ]
};

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function init() {
  const auth = await fetch('/api/check-auth').then(r=>r.json());
  if (!auth.authenticated) return window.location.href='index.html';
  currentUser = auth;
  document.getElementById('user-name').textContent = auth.full_name || auth.username;
  await loadRoles();
  const params = new URLSearchParams(window.location.search);
  if (params.get('room')) document.getElementById('room-code-input').value = params.get('room').toUpperCase();
  setupViolationMonitors();
}

async function loadRoles() {
  try {
    const data = await fetch('/api/job-roles').then(r=>r.json());
    const sel = document.getElementById('role-select');
    sel.innerHTML = data.roles.map(r=>`<option value="${r}">${r}</option>`).join('');
  } catch(e) {
    console.error('Could not load roles:', e);
  }
}

// ‚îÄ‚îÄ FULLSCREEN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('fs-btn').addEventListener('click', async () => {
  try {
    await document.documentElement.requestFullscreen();
    document.getElementById('fs-overlay').style.display = 'none';
    await initCamera();
  } catch(e) {
    // Allow continuing without fullscreen for dev/testing
    document.getElementById('fs-overlay').style.display = 'none';
    await initCamera();
  }
});

// ‚îÄ‚îÄ JOIN / START ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function joinOrStart() {
  const code = document.getElementById('room-code-input').value.trim().toUpperCase();
  const role = document.getElementById('role-select').value;

  if (code.length >= 6) {
    const data = await fetch(`/api/join-session/${code}`).then(r=>r.json());
    if (!data.success) return alert(data.message || 'Session not found');
    sessionData = data.session;
    startSession(data);
  } else {
    if (!role) return alert('Please select a job role');
    const data = await fetch('/api/create-session', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({job_role: role, mode: 'ai_interview'})
    }).then(r=>r.json());
    if (!data.success) return alert(data.message || 'Error creating session');
    sessionData = data.session;
    const joined = await fetch(`/api/join-session/${data.room_code}`).then(r=>r.json());
    startSession(joined);
  }
}

function startSession(data) {
  sessionData = data.session;
  document.getElementById('mode-selector').style.display = 'none';
  examStarted = true;
  examStartTime = Date.now();
  fetch(`/api/start-session/${sessionData.id}`, {method:'POST'});

  if (sessionData.mode === 'mcq') {
    mcqQuestions = data.questions || [];
    startMCQ();
  } else if (sessionData.mode === 'ai_interview') {
    startAIInterview();
  } else if (sessionData.mode === 'live_recruiter') {
    startLiveInterview(data.ice_servers || []);
  }

  startTimer();
  initSocket();
}

// ‚îÄ‚îÄ CAMERA & PROCTORING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function initCamera() {
  try {
    camStream = await navigator.mediaDevices.getUserMedia({video:{width:640,height:480}});
    document.getElementById('proctor-cam').srcObject = camStream;
    document.getElementById('cam-status-overlay').style.display = 'none';
    setStatus('face-status','ok','‚úÖ Camera active');
    setTimeout(startProctoring, 1500);
  } catch(e) {
    setStatus('face-status','bad','‚ùå Camera denied');
    logVio('camera_denied');
  }
}

function startProctoring() {
  setInterval(runFaceCheck, 3000);
  setInterval(runGazeCheck, 4000);
  setInterval(runDeviceCheck, 6000);
  setInterval(updateScore, 5000);
}

async function captureFrame() {
  const video = document.getElementById('proctor-cam');
  if (!video || !video.videoWidth) return null;
  const canvas = document.createElement('canvas');
  canvas.width = video.videoWidth; canvas.height = video.videoHeight;
  canvas.getContext('2d').drawImage(video, 0, 0);
  return canvas.toDataURL('image/jpeg', 0.7);
}

async function runFaceCheck() {
  const img = await captureFrame(); if (!img) return;
  const res = await fetch('/detect-face', {method:'POST',headers:{'Content-Type':'application/json'},
    body:JSON.stringify({image:img,session_id:sessionData?.id})}).then(r=>r.json()).catch(()=>null);
  if (!res) return;
  if (res.face_detected) setStatus('face-status','ok','‚úÖ Face detected');
  else if (res.num_faces===0) setStatus('face-status','warn','‚ö†Ô∏è No face visible');
  else setStatus('face-status','bad','üö´ Multiple faces');
}

async function runGazeCheck() {
  const img = await captureFrame(); if (!img) return;
  const res = await fetch('/analyze-gaze', {method:'POST',headers:{'Content-Type':'application/json'},
    body:JSON.stringify({image:img,session_id:sessionData?.id})}).then(r=>r.json()).catch(()=>null);
  if (!res?.success) return;
  const g = res.gaze;
  if (g.looking_away) {
    gazeAlerts++;
    document.getElementById('gaze-count').textContent = gazeAlerts;
    setStatus('gaze-status','bad',`üëÅÔ∏è Looking ${g.direction}`);
} else {
    setStatus('gaze-status','ok','üëÅÔ∏è Gaze: On screen');
  }
}

async function runDeviceCheck() {
  const img = await captureFrame(); if (!img) return;
  const res = await fetch('/detect-device', {method:'POST',headers:{'Content-Type':'application/json'},
    body:JSON.stringify({image:img,session_id:sessionData?.id})}).then(r=>r.json()).catch(()=>null);
  if (!res) return;
  if (res.phone_detected) {
    setStatus('device-status','bad',`üì± Phone detected! (${Math.round(res.confidence*100)}%)`);
} else {
    setStatus('device-status','ok','üì± No device detected');
  }
}

async function updateScore() {
  const res = await fetch(`/get-credibility-score?session_id=${sessionData?.id||''}`).then(r=>r.json()).catch(()=>null);
  if (!res?.success) return;
  const s = res.credibility_score;
  const el = document.getElementById('cred-score');
  el.textContent = s;
  el.style.color = s>=80?'#10b981':s>=60?'#f59e0b':'#f43f5e';
  document.getElementById('vio-count').textContent = res.total_violations;
  violations = res.total_violations;
}

function setStatus(id, type, text) {
  const el = document.getElementById(id);
  el.className = 'status-pill ' + (type==='ok'?'ok':type==='warn'?'warn':'bad');
  el.textContent = text;
}

function logVio(type) {
  violations++;
  fetch('/log-violation',{method:'POST',headers:{'Content-Type':'application/json'},
    body:JSON.stringify({violation_type:type,session_id:sessionData?.id})});
  const log = document.getElementById('vio-log');
  if (log.querySelector('div[style]')) log.innerHTML = '';
  const item = document.createElement('div');
  item.className = 'vio-item';
  item.textContent = `${new Date().toLocaleTimeString()}: ${type.replace(/_/g,' ')}`;
  log.appendChild(item);
  log.scrollTop = log.scrollHeight;
  document.getElementById('vio-count').textContent = violations;
  // violation logged to proctoring sidebar
  updateScore();
}

// ‚îÄ‚îÄ MCQ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function startMCQ() {
  document.getElementById('mcq-area').style.display = 'block';
  document.getElementById('mcq-title').textContent = `MCQ: ${sessionData.job_role}`;
  buildDots(); renderQ();
}

function buildDots() {
  const el = document.getElementById('q-dots');
  el.innerHTML = mcqQuestions.map((_,i)=>`<div class="qdot ${i===0?'curr':''}" id="dot-${i}" onclick="goQ(${i})"></div>`).join('');
}

function renderQ() {
  const q = mcqQuestions[currentQ];
  if (!q) return;
  document.getElementById('q-num').textContent = `Question ${currentQ+1} of ${mcqQuestions.length}`;
  document.getElementById('q-text').textContent = q.question_text || q.question;
  document.getElementById('q-counter').textContent = `${Object.keys(mcqAnswers).length}/${mcqQuestions.length}`;
  document.getElementById('q-answered').textContent = `${Object.keys(mcqAnswers).length} answered`;
  const opts = q.options || {a:q.option_a,b:q.option_b,c:q.option_c,d:q.option_d};
  document.getElementById('q-options').innerHTML = Object.entries(opts).map(([k,v])=>`
    <div class="opt ${mcqAnswers[currentQ]===k?'selected':''}" onclick="selectOpt('${k}')">
      <div class="opt-letter">${k.toUpperCase()}</div>
      <span>${v}</span>
    </div>`).join('');
  document.querySelectorAll('.qdot').forEach((d,i)=>{
    d.className = 'qdot';
    if (mcqAnswers[i]) d.classList.add('ans');
    if (i===currentQ) d.classList.add('curr');
  });
  document.getElementById('btn-prev').style.opacity = currentQ>0?1:0.3;
  document.getElementById('btn-next').textContent = currentQ<mcqQuestions.length-1?'Next ‚Üí':'Review';
}

function selectOpt(k) { mcqAnswers[currentQ] = k; renderQ(); }
function navQ(dir) { goQ(currentQ+dir); }
function goQ(idx) { if (idx<0||idx>=mcqQuestions.length) return; currentQ=idx; renderQ(); }
function confirmSubmitMCQ() {
  const unanswered = mcqQuestions.length - Object.keys(mcqAnswers).length;
  if (unanswered>0 && !confirm(`${unanswered} question(s) unanswered. Submit anyway?`)) return;
  submitExam('mcq');
}

// ‚îÄ‚îÄ AI INTERVIEW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function startAIInterview() {
  document.getElementById('ai-area').style.display = 'block';
  document.getElementById('ai-loading').style.display = 'flex';
  document.getElementById('ai-q-box').style.display = 'none';
  document.getElementById('ai-answer-area').style.display = 'none';
  document.getElementById('ai-error-box').style.display = 'none';
  setAIStatus('Connecting to AI engine‚Ä¶');

  startAIPipCamera(); // show candidate in PiP corner
  initAvatarCanvas(); // start realistic canvas renderer
  await loadAIQuestions();
}

async function loadAIQuestions() {
  try {
    document.getElementById('ai-load-detail').textContent = 'Generating personalized questions for ' + sessionData.job_role + '‚Ä¶';

    const res = await fetch('/api/ai-generate-questions', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({job_role: sessionData.job_role})
    });

    const data = await res.json();
    aiQuestions = data.questions || [];

    if (!aiQuestions.length) {
      throw new Error('No questions returned from server');
    }

    // Success ‚Äî hide loader, show interview
    document.getElementById('ai-loading').style.display = 'none';
    document.getElementById('ai-q-box').style.display = 'block';
    document.getElementById('ai-answer-area').style.display = 'block';
    setAIStatus('Alex is ready. Listen carefully‚Ä¶');
    updateAIProgress();

    // Small delay so user sees Alex before question types
    setTimeout(() => typeQuestion(aiQuestions[0]), 800);

  } catch(err) {
    console.error('AI question load error:', err);

    // Use fallback questions so the interview still works
    const fallbackKey = sessionData.job_role in FALLBACK_QUESTIONS
      ? sessionData.job_role : 'default';
    aiQuestions = FALLBACK_QUESTIONS[fallbackKey] || FALLBACK_QUESTIONS.default;

    document.getElementById('ai-loading').style.display = 'none';
    document.getElementById('ai-error-box').style.display = 'block';
    document.getElementById('ai-error-msg').textContent =
      'AI engine not connected (API key may not be set). Using standard questions instead. Set ANTHROPIC_API_KEY and restart for full AI experience.';

    // Still start the interview with fallback questions after 3 seconds
    setTimeout(() => {
      document.getElementById('ai-error-box').style.display = 'none';
      document.getElementById('ai-q-box').style.display = 'block';
      document.getElementById('ai-answer-area').style.display = 'block';
      setAIStatus('Starting with standard questions‚Ä¶');
      updateAIProgress();
      typeQuestion(aiQuestions[0]);
    }, 3000);
  }
}

function retryLoadQuestions() {
  document.getElementById('ai-error-box').style.display = 'none';
  document.getElementById('ai-loading').style.display = 'flex';
  aiQuestions = []; aiCurrentQ = 0; aiTranscript = []; aiTotalScore = 0;
  loadAIQuestions();
}

// ‚îÄ‚îÄ TYPE ANIMATION ‚Äî Alex types like a human ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function typeQuestion(q) {
  const qtext = q.question || q.question_text || '';
  const el = document.getElementById('ai-q-text');
  document.getElementById('ai-q-num').textContent = `Question ${aiCurrentQ+1} of ${aiQuestions.length}`;
  document.getElementById('ai-answer').value = '';
  document.getElementById('feedback-box').style.display = 'none';
  document.getElementById('send-btn').disabled = true;  // disable until typing done

  setAIStatus('Alex is asking‚Ä¶');
  setAvatarSpeaking(true);
  el.innerHTML = '<span class="cursor"></span>';

  let i = 0;
  // Variable typing speed ‚Äî feels more human
  function typeNext() {
    if (i >= qtext.length) {
      // Done typing
      el.innerHTML = qtext;
      setAvatarSpeaking(false);
      setAIStatus('Your turn to answer');
      document.getElementById('send-btn').disabled = false;
      document.getElementById('ai-answer').focus();

      // Speak the question out loud
      if ('speechSynthesis' in window) {
        speechSynthesis.cancel();
        const utt = new SpeechSynthesisUtterance(qtext);
        utt.rate = 0.92;
        utt.pitch = 1.05;
        utt.volume = 1;
        // Use Indian English female voice
        const voices = speechSynthesis.getVoices();
        const preferred = voices.find(v =>
          (v.lang === 'en-IN' && v.name.toLowerCase().includes('female')) ||
          v.name.includes('Google ‡§π‡§ø‡§®‡•ç‡§¶‡•Ä') ||
          (v.lang === 'en-IN') ||
          v.name.includes('Veena') ||
          v.name.includes('Raveena') ||
          v.name.includes('Heera') ||
          (v.name.toLowerCase().includes('google') && v.lang.startsWith('en') && v.name.toLowerCase().includes('india'))
        );
        if (preferred) {
          utt.voice = preferred;
        } else {
          // Fallback: pick any female-sounding voice and simulate Indian accent via lang
          utt.lang = 'en-IN';
          const fallback = voices.find(v => v.lang === 'en-IN') ||
                           voices.find(v => v.name.includes('Samantha') || v.name.includes('Karen') || v.name.includes('Moira'));
          if (fallback) utt.voice = fallback;
        }
        utt.pitch = 1.15;
        utt.rate = 0.88;
        utt.onstart = () => setAvatarSpeaking(true);
        utt.onend = () => setAvatarSpeaking(false);
        utt.onerror = () => setAvatarSpeaking(false);
        speechSynthesis.speak(utt);
      }
      return;
    }

    el.innerHTML = qtext.substring(0, i+1) + '<span class="cursor"></span>';
    i++;

    // Vary speed: slower at punctuation (feels natural), faster in middle of words
    const ch = qtext[i-1];
    const delay = (ch === '.' || ch === '?' || ch === '!') ? 280
                : (ch === ',') ? 120
                : (ch === ' ') ? 45
                : 22 + Math.random() * 15;
    setTimeout(typeNext, delay);
  }

  // Short pause before Alex starts typing (like a human thinking)
  setTimeout(typeNext, 600);
}

// ‚îÄ‚îÄ AI Avatar: speaking state ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let aiCallSeconds = 0, aiCallTimerInterval = null;

function setAvatarSpeaking(s) {
  const call = document.getElementById('ai-video-call');
  const wave = document.getElementById('ai-audio-wave');
  const mic  = document.getElementById('ai-mic-icon');
  const img  = document.getElementById('ai-avatar-img-wrap');
  if (call) call.classList.toggle('speaking', s);
  if (wave) wave.classList.toggle('active', s);
  if (mic)  mic.classList.toggle('active', s);
  if (img)  img.classList.toggle('talking', s);
}

function startAICallTimer() {
  if (aiCallTimerInterval) return;
  aiCallTimerInterval = setInterval(() => {
    aiCallSeconds++;
    const m = String(Math.floor(aiCallSeconds / 60)).padStart(2,'0');
    const s = String(aiCallSeconds % 60).padStart(2,'0');
    const el = document.getElementById('ai-call-timer');
    if (el) el.textContent = `${m}:${s}`;
  }, 1000);
}

// ‚îÄ‚îÄ PiP camera ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function startAIPipCamera() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({video:true, audio:false});
    const pip = document.getElementById('pip-cam');
    if (pip) pip.srcObject = stream;
  } catch(e) { console.log('PiP cam not available'); }
}

function initAvatarCanvas() { startAICallTimer(); }

function setAIStatus(txt) {
  document.getElementById('ai-status').textContent = txt;
}

function updateAIProgress() {
  const pct = (aiCurrentQ / Math.max(aiQuestions.length, 1)) * 100;
  document.getElementById('ai-progress').style.width = pct + '%';
}

// ‚îÄ‚îÄ SUBMIT AI ANSWER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function submitAIAnswer() {
  const answer = document.getElementById('ai-answer').value.trim();
  if (!answer) return alert('Please write your answer before submitting.');

  if (isRecording) toggleVoice(); // stop recording first

  document.getElementById('send-btn').disabled = true;
  setAIStatus('Alex is evaluating your answer‚Ä¶');
  setAvatarSpeaking(true);

  const q = aiQuestions[aiCurrentQ];
  let evData = {score: 5, feedback: 'Good answer. Keep being specific with examples.', follow_up: null};

  try {
    const res = await fetch('/api/ai-evaluate-answer', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        question: q.question || q.question_text,
        answer,
        job_role: sessionData.job_role,
        expected_keywords: q.expected_keywords || []
      })
    });
    evData = await res.json();
  } catch(e) {
    // Fallback scoring by keyword match
    const keywords = q.expected_keywords || [];
    const matches = keywords.filter(kw => answer.toLowerCase().includes(kw.toLowerCase())).length;
    evData.score = Math.min(10, 4 + Math.round((matches / Math.max(keywords.length,1)) * 6));
    evData.feedback = `You scored ${evData.score}/10. ${matches} of ${keywords.length} key concepts mentioned.`;
  }

  setAvatarSpeaking(false);
  aiTotalScore += evData.score || 5;
  aiTranscript.push({
    question: q.question || q.question_text,
    answer,
    score: evData.score,
    feedback: evData.feedback
  });

  // Show feedback
  document.getElementById('feedback-box').style.display = 'block';
  document.getElementById('fb-score').textContent = `${evData.score}/10`;
  document.getElementById('fb-text').textContent = evData.feedback || '';

  // Feedback speech removed ‚Äî scores shown in UI only

  // Decide next step
  const hasFollowUp = evData.follow_up && typeof evData.follow_up === 'string' && evData.follow_up.trim();
  aiCurrentQ++;
  updateAIProgress();

  if (aiCurrentQ >= aiQuestions.length && !hasFollowUp) {
    setTimeout(finishAIInterview, 2500);
  } else {
    if (hasFollowUp) {
      // Insert follow-up at current position
      aiQuestions.splice(aiCurrentQ, 0, {
        question: evData.follow_up,
        expected_keywords: []
      });
    }
    setTimeout(() => {
      document.getElementById('send-btn').disabled = false;
      typeQuestion(aiQuestions[aiCurrentQ]);
    }, 3000);
  }
}

async function finishAIInterview() {
  setAIStatus('Generating your full evaluation report‚Ä¶');
  setAvatarSpeaking(true);

  let evalData = {
    overall_score: Math.round((aiTotalScore / Math.max(aiTranscript.length,1)) * 10),
    summary: 'Interview completed. Good effort overall.',
    recommendation: 'Maybe'
  };

  try {
    const res = await fetch('/api/ai-final-evaluation', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({transcript: aiTranscript, job_role: sessionData.job_role})
    });
    evalData = await res.json();
  } catch(e) {
    console.warn('Final evaluation fallback used');
  }

  setAvatarSpeaking(false);
  const aiOverallScore = evalData.overall_score || Math.round((aiTotalScore/Math.max(aiTranscript.length,1))*10);
  submitExam('ai_interview', aiOverallScore, evalData);
}

// ‚îÄ‚îÄ VOICE INPUT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleVoice() {
  if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
    return alert('Speech recognition not supported. Please type your answer instead.');
  }
  if (isRecording) {
    speechRec?.stop();
    isRecording = false;
    document.getElementById('voice-btn').className = 'btn-voice';
    document.getElementById('voice-btn').innerHTML = 'üé§ Start Recording';
  } else {
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    speechRec = new SR();
    speechRec.continuous = true;
    speechRec.interimResults = true;
    speechRec.lang = 'en-IN';

    // Keep accumulated finalized text so pauses/restarts don't wipe it
    let committedText = document.getElementById('ai-answer').value.trim();
    if (committedText) committedText += ' ';

    speechRec.onresult = e => {
      let interim = '';
      for (let i = e.resultIndex; i < e.results.length; i++) {
        const res = e.results[i];
        if (res.isFinal) {
          committedText += res[0].transcript + ' ';
        } else {
          interim += res[0].transcript;
        }
      }
      document.getElementById('ai-answer').value = (committedText + interim).trim();
    };

    // Auto-restart after silence cutoff so recording keeps going
    speechRec.onend = () => {
      if (isRecording) {
        try { speechRec.start(); } catch(err) {}
      }
    };

    speechRec.onerror = e => {
      if (e.error === 'no-speech') return; // silence ‚Äî onend will restart
      isRecording = false;
      document.getElementById('voice-btn').className = 'btn-voice';
      document.getElementById('voice-btn').innerHTML = 'üé§ Start Recording';
    };

    speechRec.start();
    isRecording = true;
    document.getElementById('voice-btn').className = 'btn-voice recording';
    document.getElementById('voice-btn').innerHTML = '‚èπ Stop Recording';
  }
}

// ‚îÄ‚îÄ LIVE RECRUITER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function startLiveInterview(iceServers) {
  document.getElementById('live-area').style.display = 'block';
  try {
    const stream = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
    document.getElementById('local-video').srcObject = stream;
    peerConn = new RTCPeerConnection({iceServers});
    stream.getTracks().forEach(t => peerConn.addTrack(t, stream));
    peerConn.ontrack = e => { document.getElementById('remote-video').srcObject = e.streams[0]; };
    peerConn.onicecandidate = e => {
      if (e.candidate) socket?.emit('webrtc_ice_candidate', {candidate:e.candidate, room:sessionData.room_code});
    };
    const offer = await peerConn.createOffer();
    await peerConn.setLocalDescription(offer);
    socket?.emit('webrtc_offer', {sdp:offer, room:sessionData.room_code});
  } catch(e) { console.error('WebRTC error:', e); }
}

// ‚îÄ‚îÄ SOCKETIO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function initSocket() {
  socket = io();
  socket.on('connect', ()=>{ socket.emit('join_room_event', {room:sessionData?.room_code, role:'candidate'}); });
  socket.on('webrtc_offer', async data=>{ if(!peerConn) return; await peerConn.setRemoteDescription(data.sdp); const ans=await peerConn.createAnswer(); await peerConn.setLocalDescription(ans); socket.emit('webrtc_answer',{sdp:ans,room:sessionData.room_code}); });
  socket.on('webrtc_answer', async data=>{ await peerConn?.setRemoteDescription(data.sdp); });
  socket.on('webrtc_ice_candidate', async data=>{ await peerConn?.addIceCandidate(new RTCIceCandidate(data.candidate)); });
  socket.on('recruiter_message', data=>{
    const box=document.getElementById('recruiter-msgs');
    const msg=document.createElement('div');
    msg.className='rmsg recruiter';
    msg.innerHTML=`<div class="rmsg-from">Recruiter</div>${data.message}`;
    box.appendChild(msg); box.scrollTop=box.scrollHeight;
  });
  socket.on('interview_ended', ()=>{ alert('The recruiter has ended the interview.'); submitExam('live_recruiter'); });
}

// ‚îÄ‚îÄ TIMER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function startTimer() {
  let left = 45*60;
  timerInterval = setInterval(()=>{
    const m=Math.floor(left/60), s=left%60;
    const el=document.getElementById('timer');
    el.textContent=`${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    if (left<=300) el.classList.add('warn');
    if (left===0) { clearInterval(timerInterval); submitExam(sessionData?.mode||'mcq'); }
    left--;
  },1000);
}

// ‚îÄ‚îÄ SUBMIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function submitExam(mode, aiScore=0, aiFeedback={}) {
  clearInterval(timerInterval);
  if (camStream) camStream.getTracks().forEach(t=>t.stop());
  if (speechSynthesis) speechSynthesis.cancel();

  const answers = {};
  if (mode==='mcq') {
    Object.entries(mcqAnswers).forEach(([idx,val])=>{ answers[`q${parseInt(idx)+1}`]=val; });
  }

  const duration = Math.floor((Date.now()-examStartTime)/1000);
  const body = {
    session_id: sessionData?.id,
    job_role: sessionData?.job_role || 'General',
    mode, answers,
    duration_seconds: duration,
    ai_overall_score: aiScore,
    ai_feedback: aiFeedback,
  };

  try {
    const res = await fetch('/submit-test',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
    const data = await res.json();
    if (data.success) window.location.href = data.redirect;
    else alert('Submission error: ' + (data.error||'Unknown'));
  } catch(e) { alert('Network error submitting exam'); }
}

// ‚îÄ‚îÄ VIOLATION MONITORS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setupViolationMonitors() {
  document.addEventListener('visibilitychange', ()=>{ if(examStarted&&document.hidden) logVio('tab_switch'); });
  document.addEventListener('contextmenu', e=>{ if(examStarted){e.preventDefault();logVio('right_click');} });
  document.addEventListener('copy', e=>{ if(examStarted){e.preventDefault();logVio('copy_attempt');} });
  document.addEventListener('paste', e=>{ if(examStarted){e.preventDefault();logVio('paste_attempt');} });
  document.addEventListener('keydown', e=>{
    if (!examStarted) return;
    if (e.keyCode===123||(e.ctrlKey&&e.shiftKey&&[73,74].includes(e.keyCode))||(e.ctrlKey&&e.keyCode===85)) {
      e.preventDefault(); logVio('devtools');
    }
    if (e.key==='PrintScreen'||(e.metaKey&&e.shiftKey&&['3','4','5','s'].includes(e.key))) {
      e.preventDefault(); logVio('screenshot_attempt');
    }
  });
  document.addEventListener('fullscreenchange', ()=>{
    if (!examStarted) return;
    if (!document.fullscreenElement) {
      logVio('exit_fullscreen');
      }
  });
  }

// Load voices after page ready (needed for some browsers)
if ('speechSynthesis' in window) {
  speechSynthesis.getVoices();
  speechSynthesis.onvoiceschanged = () => speechSynthesis.getVoices();
}

init();
</script>
</body>
</html>