<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Interview Room ‚Äî RecruitAI</title>
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700;800&family=DM+Sans:wght@300;400;500;600&family=Plus+Jakarta+Sans:wght@700;800&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #f5f7ff;
  --bg2: #eef1fb;
  --s: #ffffff;
  --s2: #f0f3fd;
  --border: #dde3f4;
  --border2: #c8d1ee;
  --accent: #4361ee;
  --accent2: #3a56d4;
  --accent-light: rgba(67,97,238,0.09);
  --accent-glow: rgba(67,97,238,0.18);
  --green: #059669;
  --red: #dc2626;
  --yellow: #d97706;
  --text: #0f172a;
  --text2: #1e293b;
  --muted: #64748b;
  --muted2: #94a3b8;
  --shadow-sm: 0 1px 3px rgba(67,97,238,0.07), 0 1px 2px rgba(0,0,0,0.04);
  --shadow-md: 0 4px 14px rgba(67,97,238,0.1), 0 2px 6px rgba(0,0,0,0.04);
  --shadow-lg: 0 20px 60px rgba(67,97,238,0.14), 0 8px 24px rgba(0,0,0,0.06);
  --shadow: 0 2px 8px rgba(67,97,238,0.09), 0 4px 16px rgba(0,0,0,0.05);
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;}
/* ‚îÄ‚îÄ Top bar ‚îÄ‚îÄ */
.topbar{background:var(--s);border-bottom:1px solid var(--border);padding:0 24px;height:58px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:200;box-shadow:0 2px 8px rgba(0,0,0,0.3);}
.brand{font-family:'Plus Jakarta Sans',sans-serif;font-size:17px;font-weight:800;color:var(--accent2);}
.timer-wrap{display:flex;align-items:center;gap:10px;}
.timer{font-family:monospace;font-size:22px;font-weight:700;color:var(--accent2);background:var(--s2);padding:6px 14px;border-radius:8px;border:1px solid var(--border);}
.timer.warn{color:var(--red);border-color:var(--red);animation:blink 1s infinite;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.5}}
.btn-leave{padding:8px 18px;background:rgba(239,68,68,.15);border:1px solid rgba(239,68,68,.35);border-radius:8px;color:#fca5a5;font-size:13px;font-weight:600;cursor:pointer;transition:all .2s;}
.btn-leave:hover{background:rgba(239,68,68,.3);}
/* ‚îÄ‚îÄ Layout ‚îÄ‚îÄ */
.interview-layout{display:grid;grid-template-columns:1fr 340px;gap:0;min-height:calc(100vh - 58px);}
/* ‚îÄ‚îÄ Camera panel ‚îÄ‚îÄ */
.camera-panel{background:var(--bg2);border-right:1px solid var(--border);display:flex;flex-direction:column;align-items:center;justify-content:flex-start;padding:20px;gap:14px;position:sticky;top:58px;height:calc(100vh - 58px);}
.cam-box{position:relative;width:100%;aspect-ratio:4/3;background:#000;border-radius:14px;overflow:hidden;border:2px solid var(--border);}
.cam-box video{width:100%;height:100%;object-fit:cover;transform:scaleX(-1);}
.cam-overlay{position:absolute;bottom:10px;left:10px;right:10px;display:flex;justify-content:space-between;align-items:flex-end;}
.cam-status{font-size:11px;font-weight:700;padding:4px 10px;border-radius:20px;background:rgba(16,185,129,.2);color:#34d399;border:1px solid rgba(16,185,129,.3);}
.cam-status.bad{background:rgba(239,68,68,.2);color:#fca5a5;border-color:rgba(239,68,68,.3);}
.face-indicator{width:12px;height:12px;border-radius:50%;background:var(--green);box-shadow:0 0 8px var(--green);}
.face-indicator.bad{background:var(--red);box-shadow:0 0 8px var(--red);}
.session-info{width:100%;background:var(--s);border:1px solid var(--border);border-radius:12px;padding:14px;font-size:13px;}
.session-info-row{display:flex;justify-content:space-between;margin-bottom:6px;}
.session-info-row:last-child{margin-bottom:0;}
.si-lbl{color:var(--muted);font-size:12px;}
.si-val{font-weight:600;font-size:12px;}
/* ‚îÄ‚îÄ Question area ‚îÄ‚îÄ */
.qa-panel{padding:28px;overflow-y:auto;}
/* MCQ */
#mcq-area{max-width:720px;}
.q-progress{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:24px;}
.qdot{width:13px;height:13px;border-radius:50%;background:var(--s2);border:2px solid var(--border);cursor:pointer;transition:all .2s;}
.qdot.ans{background:var(--accent);border-color:var(--accent);}
.qdot.curr{border-color:var(--accent2);background:transparent;}
.question-card{background:var(--s);border:1px solid var(--border);border-radius:16px;padding:28px;margin-bottom:18px;}
.q-num{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.07em;font-weight:700;margin-bottom:10px;}
.q-text{font-size:18px;font-weight:500;line-height:1.55;margin-bottom:22px;}
.options{display:grid;gap:10px;}
.opt{display:flex;align-items:center;gap:14px;padding:14px 18px;background:var(--s2);border:2px solid var(--border);border-radius:11px;cursor:pointer;transition:all .2s;font-size:14px;}
.opt:hover{border-color:var(--accent);background:rgba(79,142,247,.08);}
.opt.selected{border-color:var(--accent);background:rgba(79,142,247,.1);}
.opt-letter{width:28px;height:28px;border-radius:7px;background:var(--s);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:12px;flex-shrink:0;transition:all .2s;}
.opt.selected .opt-letter{background:var(--accent);border-color:var(--accent);color:#fff;}
.q-nav{display:flex;justify-content:space-between;align-items:center;margin-top:16px;}
.btn-nav{padding:10px 22px;border:1px solid var(--border);border-radius:9px;background:var(--s2);color:var(--text);cursor:pointer;font-size:14px;font-weight:600;transition:all .2s;}
.btn-nav:hover{border-color:var(--accent);color:var(--accent2);}
.btn-submit{padding:12px 28px;background:var(--green);border:none;border-radius:9px;color:#fff;font-size:15px;font-weight:700;cursor:pointer;transition:all .2s;}
.btn-submit:hover{box-shadow:0 6px 20px rgba(16,185,129,0.35);}
/* AI Interview */
#ai-area{display:none;max-width:720px;}
.ai-video-box{position:relative;width:100%;aspect-ratio:16/9;max-height:360px;background:linear-gradient(135deg,#1e3a5f,#0f2a3f);border-radius:16px;overflow:hidden;margin-bottom:16px;border:1px solid var(--border);}
.ai-avatar-center{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;}
.ai-avatar-img{width:200px;height:auto;filter:drop-shadow(0 8px 32px rgba(0,0,0,0.5));}
.ai-name-tag{position:absolute;bottom:14px;left:14px;background:rgba(0,0,0,0.6);color:#fff;font-size:13px;font-weight:600;padding:4px 12px;border-radius:20px;backdrop-filter:blur(4px);}
.ai-speak-indicator{position:absolute;bottom:14px;right:14px;display:flex;gap:4px;align-items:flex-end;}
.ai-bar{width:4px;background:var(--accent);border-radius:2px;animation:bars 1.2s ease infinite;}
.ai-bar:nth-child(1){height:8px;animation-delay:0s;}
.ai-bar:nth-child(2){height:16px;animation-delay:.15s;}
.ai-bar:nth-child(3){height:10px;animation-delay:.3s;}
.ai-bar:nth-child(4){height:18px;animation-delay:.45s;}
@keyframes bars{0%,100%{opacity:.3;transform:scaleY(.4);}50%{opacity:1;transform:scaleY(1);}}
.ai-question-box{background:var(--s);border:1px solid var(--border);border-radius:14px;padding:20px;margin-bottom:16px;}
.ai-q-label{font-size:11px;color:var(--accent2);text-transform:uppercase;letter-spacing:.06em;font-weight:700;margin-bottom:8px;}
.ai-q-text{font-size:16px;font-weight:500;line-height:1.55;}
.ai-answer-box{background:var(--s);border:1px solid var(--border);border-radius:14px;padding:20px;}
.ai-a-label{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;font-weight:700;margin-bottom:10px;}
.ai-answer-textarea{width:100%;min-height:100px;background:var(--s2);border:1px solid var(--border);border-radius:10px;padding:12px 14px;color:var(--text);font-size:14px;font-family:'DM Sans',sans-serif;outline:none;resize:none;transition:border-color .2s;line-height:1.5;}
.ai-answer-textarea:focus{border-color:var(--accent);}
.ai-action-row{display:flex;justify-content:flex-end;gap:10px;margin-top:12px;}
/* Loading state */
#loading-screen{position:fixed;inset:0;background:var(--bg);z-index:999;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;}
.spinner{width:40px;height:40px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}
/* Device kick overlay */
#device-kicked-overlay{position:fixed;inset:0;background:rgba(10,10,15,0.97);z-index:9999;display:none;flex-direction:column;align-items:center;justify-content:center;gap:20px;text-align:center;padding:40px;}
.kick-icon{font-size:80px;}
.kick-title{font-family:'Playfair Display',serif;font-size:28px;font-weight:800;color:var(--red);}
.kick-desc{font-size:16px;color:var(--text2);max-width:500px;line-height:1.6;}
.kick-cta{font-size:13px;color:var(--muted);margin-top:8px;}
.countdown-badge{font-size:40px;font-weight:700;font-family:monospace;color:var(--yellow);}
/* Submit overlay */
#submitting-overlay{position:fixed;inset:0;background:rgba(10,10,15,0.95);z-index:9990;display:none;flex-direction:column;align-items:center;justify-content:center;gap:16px;text-align:center;}
/* Leave confirm */
#leave-modal{position:fixed;inset:0;background:rgba(0,0,0,0.75);z-index:8000;display:none;align-items:center;justify-content:center;backdrop-filter:blur(4px);}
.leave-card{background:var(--s);border:1px solid var(--border);border-radius:18px;padding:32px;max-width:400px;text-align:center;}
.leave-title{font-family:'Playfair Display',serif;font-size:20px;font-weight:700;margin-bottom:10px;}
.leave-desc{color:var(--muted);font-size:14px;margin-bottom:24px;line-height:1.6;}
.leave-btns{display:flex;gap:12px;justify-content:center;}

/* ‚îÄ‚îÄ 360¬∞ Room Scan Overlay ‚îÄ‚îÄ */
#room-scan-overlay {
  display:none;
  position:fixed;inset:0;z-index:9999;
  background:rgba(10,15,40,0.97);
  align-items:center;justify-content:center;flex-direction:column;
  font-family:'DM Sans',sans-serif;
}
.scan-card {
  background:#0f172a;border:1px solid rgba(67,97,238,0.3);
  border-radius:24px;padding:40px 44px;max-width:520px;width:90%;
  text-align:center;box-shadow:0 30px 80px rgba(0,0,0,0.6);
}
.scan-title {
  font-family:'Playfair Display',serif;font-size:26px;font-weight:800;
  color:#fff;margin-bottom:8px;
}
.scan-sub {
  color:#94a3b8;font-size:14px;margin-bottom:28px;line-height:1.7;
}
.scan-preview {
  width:100%;aspect-ratio:4/3;background:#000;border-radius:14px;
  overflow:hidden;margin-bottom:20px;position:relative;
  border:2px solid rgba(67,97,238,0.4);
}
.scan-preview video {
  width:100%;height:100%;object-fit:cover;transform:scaleX(-1);
}
.scan-arc {
  position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
  pointer-events:none;
}
.scan-arc svg { width:80%;height:80%;opacity:0.5; }
.scan-arc svg circle.progress {
  transition: stroke-dashoffset 0.3s ease;
  transform-origin: center;
  transform: rotate(-90deg);
}
.scan-steps {
  display:flex;gap:8px;justify-content:center;margin-bottom:20px;
}
.scan-step {
  display:flex;align-items:center;gap:6px;
  background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);
  border-radius:8px;padding:8px 14px;font-size:12px;color:#94a3b8;
  transition:all 0.3s;
}
.scan-step.active {
  background:rgba(67,97,238,0.15);border-color:rgba(67,97,238,0.5);color:#a5b4fc;
}
.scan-step.done {
  background:rgba(5,150,105,0.12);border-color:rgba(5,150,105,0.4);color:#6ee7b7;
}
.scan-instruction {
  font-size:16px;font-weight:600;color:#fff;
  background:rgba(67,97,238,0.12);border:1px solid rgba(67,97,238,0.3);
  border-radius:10px;padding:12px 20px;margin-bottom:20px;
  min-height:48px;display:flex;align-items:center;justify-content:center;
}
.scan-progress-bar {
  width:100%;height:6px;background:rgba(255,255,255,0.08);
  border-radius:99px;overflow:hidden;margin-bottom:20px;
}
.scan-progress-fill {
  height:100%;background:linear-gradient(90deg,#4361ee,#7c3aed);
  border-radius:99px;transition:width 0.4s ease;width:0%;
}
.scan-btn {
  padding:14px 36px;background:var(--accent);border:none;
  border-radius:12px;color:#fff;font-size:15px;font-weight:700;
  cursor:pointer;transition:all 0.2s;width:100%;
}
.scan-btn:hover{background:var(--accent2);transform:translateY(-1px);}
.scan-btn:disabled{opacity:0.5;cursor:not-allowed;transform:none;}
.scan-frames-grid {
  display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-bottom:16px;
}
.scan-thumb {
  aspect-ratio:4/3;background:#1e293b;border-radius:6px;overflow:hidden;
  border:2px solid rgba(255,255,255,0.05);transition:border-color 0.3s;
}
.scan-thumb.captured { border-color:rgba(5,150,105,0.6); }
.scan-thumb img { width:100%;height:100%;object-fit:cover; }
.scan-status {
  font-size:13px;color:#94a3b8;margin-bottom:16px;min-height:20px;
}
.scan-status.warn { color:#f59e0b; }
.scan-status.ok { color:#10b981; }

/* ‚îÄ‚îÄ Rules Page Overlay ‚îÄ‚îÄ */
#rules-overlay {
  display: none;
  position: fixed;
  inset: 0;
  z-index: 10000;
  background: #080c18;
  overflow-y: auto;
  font-family: 'DM Sans', sans-serif;
}
#rules-overlay.show { display: block; }

.rules-bg {
  position: fixed;
  inset: 0;
  pointer-events: none;
  overflow: hidden;
  z-index: 0;
}
.rules-bg::before {
  content: '';
  position: absolute;
  top: -20%; left: -10%;
  width: 60%; height: 60%;
  background: radial-gradient(ellipse, rgba(67,97,238,0.18) 0%, transparent 70%);
  animation: driftA 12s ease-in-out infinite alternate;
}
.rules-bg::after {
  content: '';
  position: absolute;
  bottom: -10%; right: -10%;
  width: 50%; height: 50%;
  background: radial-gradient(ellipse, rgba(124,58,237,0.12) 0%, transparent 70%);
  animation: driftB 15s ease-in-out infinite alternate;
}
@keyframes driftA { from{transform:translate(0,0)} to{transform:translate(5%,8%)} }
@keyframes driftB { from{transform:translate(0,0)} to{transform:translate(-5%,-6%)} }
.rules-grid-bg {
  position: fixed;
  inset: 0;
  background-image: linear-gradient(rgba(67,97,238,0.04) 1px, transparent 1px), linear-gradient(90deg, rgba(67,97,238,0.04) 1px, transparent 1px);
  background-size: 48px 48px;
  pointer-events: none;
  z-index: 0;
}
.rules-container {
  position: relative;
  z-index: 1;
  width: 100%;
  max-width: 960px;
  margin: 0 auto;
  padding: 40px 28px 60px;
}
.rules-header { text-align: center; margin-bottom: 36px; animation: fadeSlideUp 0.6s ease both; }
.rules-brand {
  display: inline-flex; align-items: center; gap: 10px;
  background: rgba(67,97,238,0.1); border: 1px solid rgba(67,97,238,0.25);
  border-radius: 50px; padding: 8px 20px;
  font-size: 12px; font-weight: 700; color: #818cf8;
  letter-spacing: 0.06em; text-transform: uppercase; margin-bottom: 20px;
}
.rules-title {
  font-family: 'Playfair Display', serif;
  font-size: clamp(26px, 5vw, 42px);
  font-weight: 800; color: #f1f5ff; line-height: 1.15; margin-bottom: 12px;
}
.rules-title span {
  background: linear-gradient(135deg, #6aa3ff, #818cf8, #a78bfa);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
}
.rules-subtitle { font-size: 15px; color: #64748b; max-width: 540px; margin: 0 auto; line-height: 1.7; }
.section-card {
  background: rgba(255,255,255,0.025);
  border: 1px solid rgba(255,255,255,0.07);
  border-radius: 20px; padding: 26px; margin-bottom: 20px;
}
.section-card:nth-child(2) { animation: fadeSlideUp 0.6s 0.08s ease both; }
.section-card:nth-child(3) { animation: fadeSlideUp 0.6s 0.16s ease both; }
.section-card:nth-child(4) { animation: fadeSlideUp 0.6s 0.24s ease both; }
.section-card:nth-child(5) { animation: fadeSlideUp 0.6s 0.32s ease both; }
.section-heading {
  font-size: 11px; font-weight: 700; text-transform: uppercase;
  letter-spacing: 0.1em; color: #6aa3ff;
  display: flex; align-items: center; gap: 8px; margin-bottom: 18px;
}
.setup-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 18px; }
@media(max-width:600px){ .setup-grid { grid-template-columns: 1fr; } }
.setup-diagram {
  background: #0a0f1e;
  border: 1px solid rgba(67,97,238,0.2);
  border-radius: 14px;
  padding: 20px; display: flex; flex-direction: column; align-items: center;
  justify-content: center; min-height: 200px; position: relative; overflow: hidden;
}
.setup-diagram::before {
  content: ''; position: absolute; inset: 0;
  background: radial-gradient(ellipse at 50% 10%, rgba(67,97,238,0.1) 0%, transparent 60%);
}
.setup-tips { display: flex; flex-direction: column; gap: 9px; }
.tip-item {
  display: flex; align-items: flex-start; gap: 12px;
  padding: 11px 14px;
  background: rgba(255,255,255,0.025); border-radius: 10px; font-size: 13px; color: #94a3b8; line-height: 1.5;
}
.tip-item.good { border-left: 3px solid #10b981; }
.tip-item.bad  { border-left: 3px solid #ef4444; }
.tip-icon { font-size: 17px; flex-shrink: 0; }
.tip-text strong { color: #f1f5ff; display: block; font-size: 13px; margin-bottom: 2px; }
.violations-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(230px, 1fr)); gap: 11px; margin-top: 4px; }
.vio-card {
  background: rgba(239,68,68,0.04); border: 1px solid rgba(239,68,68,0.13);
  border-radius: 12px; padding: 14px; display: flex; gap: 13px;
  align-items: flex-start; transition: all 0.2s;
}
.vio-card:hover { background: rgba(239,68,68,0.08); border-color: rgba(239,68,68,0.28); }
.vio-icon-wrap {
  width: 38px; height: 38px; border-radius: 9px;
  display: flex; align-items: center; justify-content: center; font-size: 19px; flex-shrink: 0;
}
.vio-icon-wrap.sev1 { background: rgba(245,158,11,0.15); }
.vio-icon-wrap.sev2 { background: rgba(239,68,68,0.15); }
.vio-icon-wrap.sev3 { background: rgba(220,38,38,0.22); }
.vio-name { font-size: 13px; font-weight: 700; color: #f1f5ff; margin-bottom: 3px; }
.vio-desc { font-size: 11.5px; color: #64748b; line-height: 1.5; }
.vio-sev {
  font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.06em;
  padding: 2px 8px; border-radius: 20px; margin-top: 6px; display: inline-block;
}
.vio-sev.s1 { background: rgba(245,158,11,0.15); color: #fbbf24; }
.vio-sev.s2 { background: rgba(239,68,68,0.15); color: #f87171; }
.vio-sev.s3 { background: rgba(220,38,38,0.22); color: #fca5a5; }
.score-bar-track {
  height: 14px; background: rgba(255,255,255,0.06);
  border-radius: 99px; overflow: hidden; position: relative; margin-bottom: 8px;
}
.score-bar-fill {
  height: 100%; border-radius: 99px;
  background: linear-gradient(90deg, #ef4444 0%, #f59e0b 38%, #10b981 72%, #10b981 100%);
}
.score-bar-labels { display: flex; justify-content: space-between; font-size: 11px; color: #475569; margin-bottom: 14px; }
.score-levels { display: flex; gap: 10px; flex-wrap: wrap; }
.score-level {
  padding: 10px 16px; border-radius: 9px; font-size: 12px; font-weight: 600;
  text-align: center; min-width: 80px;
}
.score-level.fail { background: rgba(239,68,68,0.1); color: #f87171; border: 1px solid rgba(239,68,68,0.2); }
.score-level.warn { background: rgba(245,158,11,0.1); color: #fbbf24; border: 1px solid rgba(245,158,11,0.2); }
.score-level.pass { background: rgba(16,185,129,0.1); color: #34d399; border: 1px solid rgba(16,185,129,0.2); }
.score-level .lvl-num { font-size: 20px; font-weight: 800; display: block; }
.score-level .lvl-lbl { font-size: 10px; opacity: 0.75; margin-top: 2px; }
.checklist-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 9px; margin-top: 4px; }
@media(max-width:560px){ .checklist-grid { grid-template-columns: 1fr; } }
.check-item {
  display: flex; align-items: center; gap: 10px;
  font-size: 13px; color: #cbd5e1; padding: 10px 13px;
  background: rgba(255,255,255,0.02); border-radius: 8px;
  border: 1px solid rgba(255,255,255,0.05);
}
.check-item .ci { font-size: 16px; }
.rules-cta { text-align: center; animation: fadeSlideUp 0.6s 0.38s ease both; }
.rules-cta-btn {
  display: inline-flex; align-items: center; gap: 12px;
  padding: 17px 52px;
  background: linear-gradient(135deg, #4361ee, #6d83f3);
  border: none; border-radius: 14px;
  color: #fff; font-size: 16px; font-weight: 700; font-family: 'DM Sans', sans-serif;
  cursor: pointer; transition: all 0.25s;
  box-shadow: 0 8px 32px rgba(67,97,238,0.38);
}
.rules-cta-btn:hover { transform: translateY(-2px); box-shadow: 0 16px 48px rgba(67,97,238,0.5); }
.rules-cta-btn:active { transform: translateY(0); }
.rules-cta-sub { margin-top: 12px; font-size: 12px; color: #475569; }
@keyframes fadeSlideUp { from{opacity:0;transform:translateY(22px)} to{opacity:1;transform:translateY(0)} }
/* Consent checkbox */
.consent-row { display:flex; align-items:center; gap:10px; margin-bottom:20px; justify-content:center; }
.consent-row input[type=checkbox] { width:18px; height:18px; accent-color:#4361ee; cursor:pointer; }
.consent-row label { font-size:13px; color:#94a3b8; cursor:pointer; }
#rules-cta-btn-main { opacity:0.45; pointer-events:none; transition: all 0.3s; }
#rules-cta-btn-main.enabled { opacity:1; pointer-events:auto; }

</style>
</head>
<body>

<div id="loading-screen">
  <div class="spinner"></div>
  <div style="color:var(--muted);font-size:14px;">Loading your interview session‚Ä¶</div>
</div>



<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- RULES & SETUP PAGE ‚Äî shown before 360¬∞ scan           -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="rules-overlay">
  <div class="rules-bg"></div>
  <div class="rules-grid-bg"></div>
  <div class="rules-container">

    <!-- Header -->
    <div class="rules-header">
      <div class="rules-brand">ü§ñ RecruitAI &nbsp;¬∑&nbsp; Pre-Interview Briefing</div>
      <div class="rules-title">Before We Begin,<br><span>Read These Rules</span></div>
      <div class="rules-subtitle">Your interview is AI-proctored. Please read the setup guide and violation rules carefully before starting.</div>
    </div>

    <!-- 1. Camera & Environment Setup -->
    <div class="section-card">
      <div class="section-heading">üì∑ &nbsp; Camera & Environment Setup</div>
      <div class="setup-grid">
        <!-- SVG Diagram -->
        <div class="setup-diagram">
          <svg width="180" height="190" viewBox="0 0 180 190" fill="none" xmlns="http://www.w3.org/2000/svg">
            <!-- Monitor / Camera frame at top -->
            <rect x="55" y="8" width="70" height="50" rx="6" fill="#1e2a4a" stroke="#4361ee" stroke-width="1.5"/>
            <rect x="61" y="14" width="58" height="38" rx="3" fill="#0d1220"/>
            <!-- Camera dot -->
            <circle cx="90" cy="11" r="2.5" fill="#4361ee"/>
            <!-- Face inside monitor (candidate visible) -->
            <circle cx="90" cy="33" r="12" fill="#2a3a6a" stroke="#6aa3ff" stroke-width="1"/>
            <circle cx="86" cy="31" r="2" fill="#6aa3ff" opacity="0.7"/>
            <circle cx="94" cy="31" r="2" fill="#6aa3ff" opacity="0.7"/>
            <path d="M85 37 Q90 41 95 37" stroke="#6aa3ff" stroke-width="1.2" stroke-linecap="round" fill="none"/>
            <!-- Monitor stand -->
            <rect x="86" y="58" width="8" height="12" rx="2" fill="#2a3560"/>
            <rect x="74" y="68" width="32" height="4" rx="2" fill="#2a3560"/>
            <!-- Desk surface -->
            <rect x="20" y="110" width="140" height="8" rx="3" fill="#1a2240" stroke="#2a3560" stroke-width="1"/>
            <!-- Person body (simple) -->
            <ellipse cx="90" cy="155" rx="26" ry="20" fill="#1a2240" stroke="#334177" stroke-width="1.2"/>
            <!-- Person head -->
            <circle cx="90" cy="100" r="18" fill="#1e2a50" stroke="#4361ee" stroke-width="1.5"/>
            <circle cx="84" cy="97" r="2.5" fill="#6aa3ff" opacity="0.8"/>
            <circle cx="96" cy="97" r="2.5" fill="#6aa3ff" opacity="0.8"/>
            <path d="M83 105 Q90 110 97 105" stroke="#6aa3ff" stroke-width="1.2" stroke-linecap="round" fill="none"/>
            <!-- Good posture arrow -->
            <line x1="135" y1="30" x2="135" y2="100" stroke="#10b981" stroke-width="1.5" stroke-dasharray="4 3" opacity="0.7"/>
            <text x="140" y="45" fill="#10b981" font-size="9" font-family="sans-serif" opacity="0.9">Eye</text>
            <text x="140" y="55" fill="#10b981" font-size="9" font-family="sans-serif" opacity="0.9">level</text>
            <!-- Distance bracket -->
            <line x1="22" y1="78" x2="60" y2="78" stroke="#f59e0b" stroke-width="1.2" stroke-dasharray="3 3" opacity="0.7"/>
            <text x="24" y="92" fill="#f59e0b" font-size="8.5" font-family="sans-serif" opacity="0.9">50-80cm</text>
            <!-- Green checkmark badge -->
            <circle cx="136" cy="148" r="14" fill="rgba(16,185,129,0.15)" stroke="#10b981" stroke-width="1.2"/>
            <text x="130" y="153" fill="#10b981" font-size="13">‚úì</text>
          </svg>
          <div style="font-size:11px;color:#475569;margin-top:8px;text-align:center;position:relative;z-index:1;">Correct camera position</div>
        </div>
        <!-- Tips -->
        <div class="setup-tips">
          <div class="tip-item good">
            <span class="tip-icon">‚úÖ</span>
            <div class="tip-text"><strong>Face at camera eye-level</strong>Position your camera so your face is centred ‚Äî not looking up or down at a steep angle.</div>
          </div>
          <div class="tip-item good">
            <span class="tip-icon">‚úÖ</span>
            <div class="tip-text"><strong>50‚Äì80 cm from screen</strong>Sit at a comfortable arm's length. Your full face and shoulders should be clearly visible.</div>
          </div>
          <div class="tip-item good">
            <span class="tip-icon">‚úÖ</span>
            <div class="tip-text"><strong>Well-lit, plain background</strong>Use natural or front-facing light. Avoid sitting with a bright window behind you.</div>
          </div>
          <div class="tip-item good">
            <span class="tip-icon">‚úÖ</span>
            <div class="tip-text"><strong>Quiet, private room</strong>Ensure no one else enters during the session. You must be alone in the frame.</div>
          </div>
          <div class="tip-item bad">
            <span class="tip-icon">‚ùå</span>
            <div class="tip-text"><strong>No phones or extra devices</strong>Remove all visible phones, tablets, smart watches or earpieces before starting.</div>
          </div>
          <div class="tip-item bad">
            <span class="tip-icon">‚ùå</span>
            <div class="tip-text"><strong>No headphones (unless wired)</strong>Bluetooth earpieces are flagged as a violation. Wired earphones are permitted.</div>
          </div>
        </div>
      </div>
    </div>

    <!-- 2. Violations -->
    <div class="section-card">
      <div class="section-heading">‚ö†Ô∏è &nbsp; What Gets Flagged ‚Äî Violations & Penalties</div>
      <div class="violations-grid">
        <div class="vio-card">
          <div class="vio-icon-wrap sev2"><span>üë§</span></div>
          <div>
            <div class="vio-name">Face Not Detected</div>
            <div class="vio-desc">Your face is not visible in the camera for more than a moment. Stay in frame at all times.</div>
            <span class="vio-sev s2">Medium ‚Äî ‚àí10 pts</span>
          </div>
        </div>
        <div class="vio-card">
          <div class="vio-icon-wrap sev2"><span>üë•</span></div>
          <div>
            <div class="vio-name">Multiple Faces</div>
            <div class="vio-desc">More than one person is detected in the camera frame. You must be alone.</div>
            <span class="vio-sev s2">Medium ‚Äî ‚àí10 pts</span>
          </div>
        </div>
        <div class="vio-card">
          <div class="vio-icon-wrap sev1"><span>üëÄ</span></div>
          <div>
            <div class="vio-name">Gaze Away</div>
            <div class="vio-desc">Your eyes are consistently looking away from the screen. Focus on the interview.</div>
            <span class="vio-sev s1">Low ‚Äî ‚àí5 pts</span>
          </div>
        </div>
        <div class="vio-card">
          <div class="vio-icon-wrap sev3"><span>üì±</span></div>
          <div>
            <div class="vio-name">Device Detected</div>
            <div class="vio-desc">A phone, tablet, laptop screen or Bluetooth earpiece is visible in your camera view.</div>
            <span class="vio-sev s3">High ‚Äî ‚àí15 pts</span>
          </div>
        </div>
        <div class="vio-card">
          <div class="vio-icon-wrap sev2"><span>ü™ü</span></div>
          <div>
            <div class="vio-name">Tab Switch</div>
            <div class="vio-desc">You switched to another browser tab or application during the interview.</div>
            <span class="vio-sev s2">Medium ‚Äî ‚àí10 pts</span>
          </div>
        </div>
        <div class="vio-card">
          <div class="vio-icon-wrap sev1"><span>üñ±Ô∏è</span></div>
          <div>
            <div class="vio-name">Right-Click / Copy</div>
            <div class="vio-desc">Right-clicking or using Ctrl+C during the exam is flagged as a potential cheating attempt.</div>
            <span class="vio-sev s1">Low ‚Äî ‚àí5 pts</span>
          </div>
        </div>
      </div>
    </div>

    <!-- 3. Credibility Score -->
    <div class="section-card">
      <div class="section-heading">üõ°Ô∏è &nbsp; Your Credibility Score</div>
      <p style="font-size:13px;color:#64748b;margin-bottom:16px;line-height:1.7;">
        You start with <strong style="color:#f1f5ff;">100 points</strong>. Every violation detected deducts points. Your recruiter sees this score in real-time. You need at least <strong style="color:#34d399;">60 points</strong> to pass.
      </p>
      <div class="score-bar-track">
        <div class="score-bar-fill"></div>
      </div>
      <div class="score-bar-labels"><span>0 ‚Äî Fail</span><span>60 ‚Äî Pass threshold</span><span>100 ‚Äî Perfect</span></div>
      <div class="score-levels">
        <div class="score-level fail"><span class="lvl-num">0‚Äì59</span><div class="lvl-lbl">‚ùå Fail</div></div>
        <div class="score-level warn"><span class="lvl-num">60‚Äì79</span><div class="lvl-lbl">‚ö† Acceptable</div></div>
        <div class="score-level pass"><span class="lvl-num">80‚Äì100</span><div class="lvl-lbl">‚úÖ Excellent</div></div>
      </div>
    </div>

    <!-- 4. Pre-interview checklist -->
    <div class="section-card">
      <div class="section-heading">‚úÖ &nbsp; Pre-Interview Checklist ‚Äî Confirm Before Starting</div>
      <div class="checklist-grid">
        <div class="check-item"><span class="ci">üí°</span> Room is well-lit and bright</div>
        <div class="check-item"><span class="ci">ü§´</span> Quiet environment, no background noise</div>
        <div class="check-item"><span class="ci">üëÅÔ∏è</span> Camera is at eye level, face clearly visible</div>
        <div class="check-item"><span class="ci">üìè</span> Sitting 50‚Äì80 cm from the screen</div>
        <div class="check-item"><span class="ci">üìµ</span> Phone, tablet and all devices removed</div>
        <div class="check-item"><span class="ci">üîá</span> Bluetooth earpieces removed</div>
        <div class="check-item"><span class="ci">üîí</span> Room door closed, no one else present</div>
        <div class="check-item"><span class="ci">üåê</span> Stable internet connection confirmed</div>
      </div>
    </div>

    <!-- CTA -->
    <div class="rules-cta">
      <div class="consent-row">
        <input type="checkbox" id="rules-consent" onchange="document.getElementById('rules-cta-btn-main').classList.toggle('enabled', this.checked)">
        <label for="rules-consent">I have read all rules and my environment is set up correctly</label>
      </div>
      <button class="rules-cta-btn" id="rules-cta-btn-main" onclick="proceedToScan()">
        <span>üì∑</span> Proceed to Room Scan
      </button>
      <div class="rules-cta-sub">Next: a 360¬∞ security scan of your room will be performed (~30 seconds)</div>
    </div>

  </div><!-- /rules-container -->
</div><!-- /rules-overlay -->

<!-- 360¬∞ Room Scan Overlay -->
<div id="room-scan-overlay" style="display:none;align-items:center;justify-content:center;flex-direction:column;">
  <div class="scan-card">
    <div class="scan-title">üîç Room Security Scan</div>
    <div class="scan-sub">Before your interview begins, please do a slow 360¬∞ scan of your room so we can verify your environment is secure.</div>

    <div class="scan-preview">
      <video id="scan-video" autoplay muted playsinline></video>
      <div class="scan-arc">
        <svg viewBox="0 0 100 100" fill="none">
          <circle cx="50" cy="50" r="44" stroke="rgba(255,255,255,0.08)" stroke-width="3"/>
          <circle class="progress" id="scan-arc-circle" cx="50" cy="50" r="44"
            stroke="#4361ee" stroke-width="3"
            stroke-dasharray="276.46" stroke-dashoffset="276.46"
            stroke-linecap="round"/>
        </svg>
      </div>
    </div>

    <div class="scan-frames-grid" id="scan-frames-grid">
      <div class="scan-thumb" id="sf0"></div>
      <div class="scan-thumb" id="sf1"></div>
      <div class="scan-thumb" id="sf2"></div>
      <div class="scan-thumb" id="sf3"></div>
      <div class="scan-thumb" id="sf4"></div>
      <div class="scan-thumb" id="sf5"></div>
      <div class="scan-thumb" id="sf6"></div>
      <div class="scan-thumb" id="sf7"></div>
    </div>

    <div class="scan-steps">
      <div class="scan-step active" id="sstep-0">‚ë† Face Camera</div>
      <div class="scan-step" id="sstep-1">‚ë° Rotate Left</div>
      <div class="scan-step" id="sstep-2">‚ë¢ Rotate Right</div>
      <div class="scan-step" id="sstep-3">‚ë£ Show Desk</div>
    </div>

    <div class="scan-instruction" id="scan-instruction">üì∑ Position your face in the camera, then press Start Scan</div>
    <div class="scan-progress-bar"><div class="scan-progress-fill" id="scan-progress-fill"></div></div>
    <div class="scan-status" id="scan-status"></div>

    <button class="scan-btn" id="scan-btn" onclick="startRoomScan()">‚ñ∂ Start Room Scan</button>
  </div>
</div>

<!-- Device Kicked Overlay -->
<div id="device-kicked-overlay">
  <div class="kick-icon">üö´üì±</div>
  <div class="kick-title">Device Detected ‚Äî Interview Paused</div>
  <div class="kick-desc">A prohibited device (phone, tablet, or other electronic device) was detected by our proctoring system. You must remove all devices from the camera view before continuing.</div>
  <div class="countdown-badge" id="kick-countdown">10</div>
  <div class="kick-cta">Ensure no devices are visible. Interview resumes after a clean 10-second detection window.</div>
  <button onclick="requestRejoin()" style="margin-top:16px;padding:14px 32px;background:var(--accent);border:none;border-radius:10px;color:#fff;font-size:15px;font-weight:700;cursor:pointer;">‚úì I've removed the device ‚Äî Check Again</button>
</div>

<!-- Submitting Overlay -->
<div id="submitting-overlay">
  <div class="spinner"></div>
  <div style="font-family:'Playfair Display',serif;font-size:22px;font-weight:700;margin-top:8px;">Submitting Your Interview‚Ä¶</div>
  <div style="color:var(--muted);font-size:14px;">Please wait. Do not close this tab.</div>
</div>

<!-- Leave Modal -->
<div id="leave-modal" style="display:none;align-items:center;justify-content:center;">
  <div class="leave-card">
    <div class="leave-title">Leave Interview?</div>
    <div class="leave-desc">If you leave now, your current progress will be submitted and the session will end. Are you sure?</div>
    <div class="leave-btns">
      <button onclick="confirmLeave()" style="padding:11px 24px;background:rgba(239,68,68,.2);border:1px solid rgba(239,68,68,.4);border-radius:9px;color:#fca5a5;font-size:14px;font-weight:600;cursor:pointer;">Yes, Leave</button>
      <button onclick="closeLeaveMod()" style="padding:11px 24px;background:var(--s2);border:1px solid var(--border);border-radius:9px;color:var(--text);font-size:14px;font-weight:600;cursor:pointer;">Continue Interview</button>
    </div>
  </div>
</div>

<div id="interview-ui" style="display:none;">
  <div class="topbar">
    <div class="brand">ü§ñ RecruitAI</div>
    <div class="timer-wrap">
      <span style="font-size:12px;color:var(--muted);">Time Remaining</span>
      <div class="timer" id="timer-display">45:00</div>
    </div>
    <button class="btn-leave" onclick="showLeaveMod()">üö™ Leave Interview</button>
  </div>

  <div class="interview-layout">
    <!-- Camera Panel -->
    <div class="camera-panel">
      <div class="cam-box">
        <video id="cam-video" autoplay muted playsinline></video>
        <div class="cam-overlay">
          <span class="cam-status" id="cam-status">‚óè Camera Active</span>
          <span class="face-indicator" id="face-indicator" title="Face detection"></span>
        </div>
      </div>
      <div class="session-info">
        <div class="session-info-row"><span class="si-lbl">Role</span><span class="si-val" id="si-role">‚Äî</span></div>
        <div class="session-info-row"><span class="si-lbl">Mode</span><span class="si-val" id="si-mode">‚Äî</span></div>
        <div class="session-info-row"><span class="si-lbl">Room</span><span class="si-val" id="si-room" style="font-family:monospace;color:var(--accent2);">‚Äî</span></div>
        <div class="session-info-row" id="si-proctoring-row"><span class="si-lbl">Proctoring</span><span class="si-val" style="color:var(--green);">‚óè Active</span></div>
      </div>
    </div>

    <!-- Q&A Panel -->
    <div class="qa-panel">
      <!-- MCQ Mode -->
      <div id="mcq-area" style="display:none;">
        <div style="font-family:'Playfair Display',serif;font-size:22px;font-weight:700;margin-bottom:6px;" id="mcq-job-title">MCQ Exam</div>
        <div style="color:var(--muted);font-size:13px;margin-bottom:20px;">Answer all 10 questions and click Submit when done.</div>
        <div class="q-progress" id="q-dots"></div>
        <div class="question-card" id="question-card">
          <div class="q-num" id="q-num">Question 1 of 10</div>
          <div class="q-text" id="q-text">Loading question‚Ä¶</div>
          <div class="options" id="options"></div>
        </div>
        <div class="q-nav">
          <button class="btn-nav" onclick="prevQ()">‚Üê Previous</button>
          <button class="btn-nav" onclick="nextQ()">Next ‚Üí</button>
          <button class="btn-submit" onclick="showSubmitConfirm()">‚úì Submit Exam</button>
        </div>
      </div>

      <!-- AI Interview Mode -->
      <div id="ai-area" style="display:none;">
        <div class="ai-video-box">
          <div class="ai-avatar-center">
            <img class="ai-avatar-img" src="https://api.dicebear.com/7.x/bottts-neutral/svg?seed=Alex&backgroundColor=1e3a5f&radius=50" alt="AI Interviewer" onerror="this.style.display='none'">
          </div>
          <div class="ai-name-tag">ü§ñ Alex ‚Äî AI Interviewer</div>
          <div class="ai-speak-indicator" id="ai-speak-bars" style="display:none;">
            <div class="ai-bar"></div><div class="ai-bar"></div><div class="ai-bar"></div><div class="ai-bar"></div>
          </div>
        </div>
        <div class="ai-question-box">
          <div class="ai-q-label">Current Question</div>
          <div class="ai-q-text" id="ai-q-text">Preparing your interview‚Ä¶</div>
        </div>
        <div class="ai-answer-box">
          <div class="ai-a-label">Your Answer</div>
          <textarea class="ai-answer-textarea" id="ai-answer-input" placeholder="Type your answer here‚Ä¶"></textarea>
          <div class="ai-action-row">
            <span id="ai-q-counter" style="font-size:13px;color:var(--muted);align-self:center;"></span>
            <button id="ai-next-btn" onclick="aiNextQuestion()" style="padding:11px 24px;background:var(--accent);border:none;border-radius:9px;color:#fff;font-size:14px;font-weight:600;cursor:pointer;transition:all .2s;">Next Question ‚Üí</button>
          </div>
        </div>
      </div>

      <!-- Live Recruiter Mode -->
      <div id="live-area" style="display:none;">
        <!-- Waiting for recruiter overlay -->
        <div id="recruiter-waiting" style="padding:48px 32px;text-align:center;">
          <div style="width:80px;height:80px;border-radius:20px;background:linear-gradient(135deg,var(--accent),#6d83f3);display:flex;align-items:center;justify-content:center;font-size:36px;margin:0 auto 24px;box-shadow:0 8px 24px rgba(67,97,238,0.25);">‚è≥</div>
          <div style="font-family:'Plus Jakarta Sans',sans-serif;font-size:22px;font-weight:800;margin-bottom:10px;color:var(--text);">Waiting for Recruiter</div>
          <div style="font-size:14px;line-height:1.8;color:var(--muted);max-width:420px;margin:0 auto 28px;">
            Your interview hasn't started yet. The recruiter needs to join before you can begin. Keep your camera on and stay on this page.
          </div>
          <div style="display:inline-flex;align-items:center;gap:10px;padding:12px 24px;background:rgba(67,97,238,0.07);border:1px solid rgba(67,97,238,0.18);border-radius:50px;font-size:13px;color:var(--accent);">
            <span style="width:8px;height:8px;border-radius:50%;background:var(--accent);animation:pulse 1.4s infinite;"></span>
            Waiting for recruiter to join‚Ä¶
          </div>
          <style>@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.4;transform:scale(.85)}}</style>
        </div>
        <!-- Active session content (shown after recruiter joins) -->
        <div id="recruiter-active" style="display:none;padding-top:20px;text-align:center;color:var(--muted);">
          <div style="font-size:48px;margin-bottom:16px;">üé•</div>
          <div style="font-family:'Plus Jakarta Sans',sans-serif;font-size:20px;font-weight:700;margin-bottom:8px;color:var(--text);">Live Recruiter Session Active</div>
          <div style="font-size:14px;line-height:1.7;">Your recruiter has joined. Answer questions verbally as they ask them. Your camera and proctoring are active.</div>
          <div style="margin-top:16px;display:inline-flex;align-items:center;gap:8px;padding:8px 18px;background:rgba(5,150,105,.08);border:1px solid rgba(5,150,105,.2);border-radius:50px;font-size:13px;color:#059669;font-weight:600;">
            <span style="width:7px;height:7px;border-radius:50%;background:#059669;animation:pulse 1.4s infinite;"></span>
            Recruiter Connected
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const params = new URLSearchParams(location.search);
const ROOM_CODE = params.get('room');
let sessionData = null, questions = [], answers = {}, currentQ = 0;
let timerSec = 45 * 60, timerInterval = null;
let deviceCheckInterval = null, faceCheckInterval = null;
let aiQuestions = [], aiCurrentQ = 0, aiTranscript = [];
let deviceKicked = false, kickClearSec = 0, kickInterval = null;
let socket = null;
// FIX: flag to pause proctoring checks during rules page and room scan
let proctoringActive = false;

async function init() {
  if (!ROOM_CODE) { alert('No room code found. Please join via your email link.'); return; }
  try {
    const data = await fetch(`/api/join-session/${ROOM_CODE}`).then(r=>r.json());
    if (!data.success) {
      if (data.message === 'already_submitted') {
        window.location.href = 'test.html';
        return;
      }
      alert(data.message || 'Could not join session'); window.location.href = 'test.html'; return;
    }
    sessionData = data.session;
    sessionData.ice_servers = data.ice_servers || [];
    questions   = data.questions || [];
    document.getElementById('si-role').textContent = sessionData.job_role;
    document.getElementById('si-mode').textContent = (sessionData.mode||'mcq').replace('_',' ');
    document.getElementById('si-room').textContent = ROOM_CODE;
    await startCamera();
    document.getElementById('loading-screen').style.display = 'none';
    // Show RULES PAGE first ‚Üí then 360¬∞ scan (both awaited in sequence)
    await showRulesAndScan();
    document.getElementById('interview-ui').style.display = 'block';
    initSocket();
    loadInterviewMode();
    // For live_recruiter mode, wait for recruiter before starting session
    if (sessionData.mode === 'live_recruiter') {
      // Don't start session/timer/proctoring until recruiter joins
      // initSocket already handles the recruiter_joined event
    } else {
      await startSession();
      startTimer();
      startProctoring();
    }
  } catch(e) {
    console.error(e);
    alert('Error loading session. Please try again.');
    window.location.href = 'test.html';
  }
}

async function startCamera() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({video:true, audio:false});
    document.getElementById('cam-video').srcObject = stream;
  } catch(e) {
    document.getElementById('cam-status').textContent = '‚ö† Camera error';
    document.getElementById('cam-status').classList.add('bad');
  }
}

async function startSession() {
  await fetch(`/api/start-session/${sessionData.id}`, {method:'POST'});
}

// ‚îÄ‚îÄ Timer ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function startTimer() {
  timerSec = sessionData.mode === 'ai_interview' ? 50*60 : 45*60;
  timerInterval = setInterval(() => {
    timerSec--;
    const m = Math.floor(timerSec/60), s = timerSec%60;
    const el = document.getElementById('timer-display');
    el.textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    el.classList.toggle('warn', timerSec <= 300);
    if (timerSec <= 0) { clearInterval(timerInterval); submitInterview('timeout'); }
  }, 1000);
}

// ‚îÄ‚îÄ Proctoring ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// 360¬∞ ROOM SCAN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SCAN_STEPS = [
  { label: 'üì∑ Face the camera directly ‚Äî we can see you clearly', duration: 4000 },
  { label: '‚¨ÖÔ∏è Slowly rotate LEFT ‚Äî show the left side of your room', duration: 5000 },
  { label: '‚Ü©Ô∏è Return to center ‚Äî face the camera again', duration: 3000 },
  { label: '‚û°Ô∏è Slowly rotate RIGHT ‚Äî show the right side of your room', duration: 5000 },
  { label: '‚Ü©Ô∏è Return to center again', duration: 2000 },
  { label: '‚¨áÔ∏è Tilt down ‚Äî show your desk and keyboard area', duration: 3000 },
  { label: '‚¨ÜÔ∏è Return to normal position', duration: 2000 },
  { label: '‚úÖ Hold still ‚Äî completing scan‚Ä¶', duration: 2000 },
];
const TOTAL_SCAN_MS = SCAN_STEPS.reduce((a, s) => a + s.duration, 0);
let scanFrames = [], scanRunning = false;

// ‚îÄ‚îÄ Rules Page ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showRulesAndScan() {
  return new Promise(resolve => {
    // Step 1: show rules page
    const overlay = document.getElementById('rules-overlay');
    overlay.classList.add('show');
    // proceedToScan will be called when user clicks the button
    window._rulesResolve = async () => {
      overlay.classList.remove('show');
      // Step 2: immediately chain into the 360¬∞ room scan
      await showRoomScan();
      // Step 3: resolve the combined promise so init() can continue
      resolve();
    };
  });
}

function proceedToScan() {
  if (window._rulesResolve) {
    const fn = window._rulesResolve;
    window._rulesResolve = null;
    fn();
  }
}

function showRoomScan() {
  return new Promise(resolve => {
    const overlay = document.getElementById('room-scan-overlay');
    overlay.style.display = 'flex';
    // Mirror the already-started camera into scan video
    const scanVid = document.getElementById('scan-video');
    const camVid  = document.getElementById('cam-video');
    if (camVid.srcObject) scanVid.srcObject = camVid.srcObject;
    // Store resolve so scan completion can call it
    window._scanResolve = resolve;
  });
}

async function startRoomScan() {
  if (scanRunning) return;
  scanRunning = true;
  scanFrames = [];
  const btn  = document.getElementById('scan-btn');
  btn.disabled = true;
  btn.textContent = 'üî¥ Scanning‚Ä¶';

  let elapsed = 0;
  const stepDivs = ['sstep-0','sstep-1','sstep-2','sstep-3'];

  for (let i = 0; i < SCAN_STEPS.length; i++) {
    const step = SCAN_STEPS[i];

    // Update instruction
    document.getElementById('scan-instruction').textContent = step.label;

    // Update step indicators (map scan steps to 4 visible steps)
    const visIdx = Math.floor(i / 2);
    stepDivs.forEach((id, idx) => {
      const el = document.getElementById(id);
      if (idx < visIdx) { el.className = 'scan-step done'; }
      else if (idx === visIdx) { el.className = 'scan-step active'; }
      else { el.className = 'scan-step'; }
    });

    // Capture a frame at start of each step
    const frame = await captureScanFrame();
    if (frame) {
      const fIdx = scanFrames.length;
      scanFrames.push(frame);
      const thumb = document.getElementById('sf' + fIdx);
      if (thumb) {
        thumb.classList.add('captured');
        thumb.innerHTML = `<img src="${frame}" style="width:100%;height:100%;object-fit:cover;">`;
      }
    }

    // Animate progress arc and bar during this step
    const stepStart = Date.now();
    await new Promise(res => {
      const tick = setInterval(() => {
        const stepElapsed = Date.now() - stepStart;
        const stepPct = Math.min(stepElapsed / step.duration, 1);
        elapsed += (stepPct * step.duration / SCAN_STEPS.length);
        const totalPct = Math.min((elapsed / TOTAL_SCAN_MS) * SCAN_STEPS.length / SCAN_STEPS.length +
          (i / SCAN_STEPS.length), 1);
        const pct = (i + stepPct) / SCAN_STEPS.length;

        // Arc
        const circ = 276.46;
        document.getElementById('scan-arc-circle').setAttribute(
          'stroke-dashoffset', (circ * (1 - pct)).toFixed(2)
        );
        // Bar
        document.getElementById('scan-progress-fill').style.width = (pct * 100).toFixed(1) + '%';

        if (stepElapsed >= step.duration) {
          clearInterval(tick);
          res();
        }
      }, 80);
    });
  }

  // Mark all steps done
  stepDivs.forEach(id => document.getElementById(id).className = 'scan-step done');

  // Final frame
  const finalFrame = await captureScanFrame();
  if (finalFrame) scanFrames.push(finalFrame);

  document.getElementById('scan-progress-fill').style.width = '100%';
  document.getElementById('scan-arc-circle').setAttribute('stroke-dashoffset', '0');
  document.getElementById('scan-instruction').textContent = '‚è≥ Analysing your environment‚Ä¶';
  document.getElementById('scan-status').textContent = 'Sending scan to server‚Ä¶';
  document.getElementById('scan-status').className = 'scan-status';

  // Send frames to backend
  await submitScanFrames();
}

async function captureScanFrame() {
  const video = document.getElementById('scan-video');
  if (!video || !video.videoWidth) return null;
  const canvas = document.createElement('canvas');
  canvas.width = 320; canvas.height = 240;
  canvas.getContext('2d').drawImage(video, 0, 0, 320, 240);
  return canvas.toDataURL('image/jpeg', 0.6);
}

async function submitScanFrames() {
  try {
    const resp = await fetch('/api/room-scan', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true' },
      credentials: 'same-origin',
      body: JSON.stringify({ session_id: sessionData.id, frames: scanFrames })
    });
    const data = await resp.json();

    if (data.issues && data.issues.length > 0) {
      document.getElementById('scan-status').textContent = '‚ö† Issues found: ' + data.issues.join(', ');
      document.getElementById('scan-status').className = 'scan-status warn';
      document.getElementById('scan-instruction').textContent = '‚ö†Ô∏è Concerns noted. Interview will proceed but violations logged.';
    } else {
      document.getElementById('scan-status').textContent = '‚úÖ Environment looks clean!';
      document.getElementById('scan-status').className = 'scan-status ok';
      document.getElementById('scan-instruction').textContent = '‚úÖ Scan complete. Starting your interview‚Ä¶';
    }

    const btn = document.getElementById('scan-btn');
    btn.textContent = '‚ñ∂ Enter Interview';
    btn.disabled = false;
    btn.onclick = completeScan;

    // Auto-proceed after 2 seconds if clean
    if (!data.issues || data.issues.length === 0) {
      setTimeout(completeScan, 2000);
    }
  } catch(e) {
    console.error('Scan submit error:', e);
    document.getElementById('scan-status').textContent = 'Scan could not be verified ‚Äî proceeding anyway.';
    document.getElementById('scan-status').className = 'scan-status warn';
    setTimeout(completeScan, 1500);
  }
}

function completeScan() {
  document.getElementById('room-scan-overlay').style.display = 'none';
  if (window._scanResolve) { window._scanResolve(); window._scanResolve = null; }
}

// FIX: register browser event listeners only once at page load, but only log
// when proctoringActive is true (set by startProctoring). This prevents tab_switch
// violations firing while candidate is reading the rules page before the interview.
document.addEventListener('visibilitychange', () => {
  if (proctoringActive && document.hidden) logViolation('tab_switch');
});
document.addEventListener('contextmenu', e => {
  e.preventDefault();
  if (proctoringActive) logViolation('right_click');
});
document.addEventListener('keydown', e => {
  if (proctoringActive && (e.ctrlKey||e.metaKey) && e.key==='c') logViolation('copy_attempt');
});

function startProctoring() {
  proctoringActive = true;   // FIX: mark as active so checks start logging
  faceCheckInterval = setInterval(checkFace, 4000);
  deviceCheckInterval = setInterval(checkDevice, 7000);
}

async function captureFrame() {
  const video = document.getElementById('cam-video');
  if (!video.videoWidth) return null;
  const canvas = document.createElement('canvas');
  canvas.width = 320; canvas.height = 240;
  canvas.getContext('2d').drawImage(video, 0, 0, 320, 240);
  return canvas.toDataURL('image/jpeg', 0.7);
}

async function checkFace() {
  if (!proctoringActive || deviceKicked) return;  // FIX: don't check during rules/scan
  const img = await captureFrame();
  if (!img) return;
  try {
    const data = await fetch('/detect-face', {method:'POST', headers:{'Content-Type':'application/json'},
      body:JSON.stringify({image:img, session_id:sessionData.id})}).then(r=>r.json());
    const ok = data.face_detected && data.num_faces === 1;
    document.getElementById('face-indicator').className = 'face-indicator' + (ok?'':' bad');
    document.getElementById('cam-status').className = 'cam-status' + (ok?'':' bad');
    document.getElementById('cam-status').textContent = ok?'‚óè Camera Active':data.num_faces===0?'‚ö† Face not detected':'‚ö† Multiple faces';
  } catch(e){}
}

async function checkDevice() {
  if (!proctoringActive || deviceKicked) return;  // FIX: don't check during rules/scan
  const img = await captureFrame();
  if (!img) return;
  try {
    const data = await fetch('/detect-device', {method:'POST', headers:{'Content-Type':'application/json'},
      body:JSON.stringify({image:img, session_id:sessionData.id})}).then(r=>r.json());
    if (data.phone_detected) {
      kickCandidateOut();
    }
  } catch(e){}
}

function kickCandidateOut() {
  deviceKicked = true;
  clearInterval(deviceCheckInterval);
  const overlay = document.getElementById('device-kicked-overlay');
  overlay.style.display = 'flex';
  kickClearSec = 10;
  document.getElementById('kick-countdown').textContent = kickClearSec;
  kickInterval = setInterval(() => {
    kickClearSec--;
    document.getElementById('kick-countdown').textContent = kickClearSec;
    if (kickClearSec <= 0) clearInterval(kickInterval);
  }, 1000);
}

async function requestRejoin() {
  if (kickClearSec > 0) {
    alert(`Please wait ${kickClearSec} more seconds before trying to rejoin.`);
    return;
  }
  // Do one final device check
  const img = await captureFrame();
  if (!img) { alert('Camera not ready'); return; }
  const data = await fetch('/detect-device', {method:'POST', headers:{'Content-Type':'application/json'},
    body:JSON.stringify({image:img, session_id:sessionData.id})}).then(r=>r.json());
  if (data.phone_detected) {
    kickClearSec = 10;
    document.getElementById('kick-countdown').textContent = kickClearSec;
    kickInterval = setInterval(()=>{ kickClearSec--; document.getElementById('kick-countdown').textContent=kickClearSec; if(kickClearSec<=0) clearInterval(kickInterval); },1000);
    alert('Device still detected! Please ensure the area is clear of all prohibited devices.');
    return;
  }
  // Clear ‚Äî allow back in
  deviceKicked = false;
  document.getElementById('device-kicked-overlay').style.display = 'none';
  deviceCheckInterval = setInterval(checkDevice, 7000);
}

async function logViolation(type) {
  try {
    await fetch('/log-violation', {method:'POST', headers:{'Content-Type':'application/json'},
      body:JSON.stringify({violation_type:type, session_id:sessionData.id})});
  } catch(e){}
}

// ‚îÄ‚îÄ MCQ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function loadInterviewMode() {
  const mode = sessionData.mode;
  if (mode === 'mcq') { document.getElementById('mcq-area').style.display='block'; loadMCQ(); }
  else if (mode === 'ai_interview') { document.getElementById('ai-area').style.display='block'; loadAI(); }
  else if (mode === 'live_recruiter') { document.getElementById('live-area').style.display='block'; }
}

function loadMCQ() {
  document.getElementById('mcq-job-title').textContent = `üìù ${sessionData.job_role} ‚Äî MCQ Exam`;
  renderDots();
  renderQuestion();
}

function renderDots() {
  document.getElementById('q-dots').innerHTML = questions.map((q,i) =>
    `<div class="qdot ${answers[i]?'ans':''} ${i===currentQ?'curr':''}" onclick="goToQ(${i})" title="Q${i+1}"></div>`
  ).join('');
}

function renderQuestion() {
  if (!questions.length) return;
  const q = questions[currentQ];
  document.getElementById('q-num').textContent = `Question ${currentQ+1} of ${questions.length}`;
  document.getElementById('q-text').textContent = q.question_text;
  const opts = ['a','b','c','d'];
  document.getElementById('options').innerHTML = opts.map(k=>`
    <div class="opt ${answers[currentQ]===k?'selected':''}" onclick="selectOpt('${k}')">
      <div class="opt-letter">${k.toUpperCase()}</div>
      <div>${q.options[k]}</div>
    </div>`).join('');
  renderDots();
}

function selectOpt(key) {
  answers[currentQ] = key;
  renderQuestion();
}
function nextQ() { if (currentQ<questions.length-1) { currentQ++; renderQuestion(); } }
function prevQ() { if (currentQ>0) { currentQ--; renderQuestion(); } }
function goToQ(i) { currentQ=i; renderQuestion(); }

function showSubmitConfirm() {
  const answered = Object.keys(answers).length;
  const unanswered = questions.length - answered;
  const msg = unanswered > 0
    ? `You have ${unanswered} unanswered question(s). Submit anyway?`
    : 'Submit your exam now?';
  if (confirm(msg)) submitInterview('manual');
}

// ‚îÄ‚îÄ AI Interview ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadAI() {
  document.getElementById('ai-q-text').textContent = 'Generating your interview questions‚Ä¶';
  try {
    const data = await fetch('/api/ai-generate-questions', {method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({job_role:sessionData.job_role})}).then(r=>r.json());
    aiQuestions = data.questions || [];
    aiCurrentQ = 0;
    displayAIQuestion();
  } catch(e) {
    document.getElementById('ai-q-text').textContent = 'Error loading questions. Please leave and rejoin.';
  }
}

function displayAIQuestion() {
  if (aiCurrentQ >= aiQuestions.length) { submitInterview('ai_complete'); return; }
  const q = aiQuestions[aiCurrentQ];
  document.getElementById('ai-q-text').textContent = q.question || q.question_text;
  document.getElementById('ai-answer-input').value = '';
  document.getElementById('ai-q-counter').textContent = `${aiCurrentQ+1} / ${aiQuestions.length}`;
  const isLast = aiCurrentQ >= aiQuestions.length - 1;
  const btn = document.getElementById('ai-next-btn');
  btn.textContent = isLast ? '‚úì Finish Interview' : 'Next Question ‚Üí';
  // Speak the question
  speakText(q.question || q.question_text);
  document.getElementById('ai-speak-bars').style.display='flex';
}

function speakText(text) {
  if (!window.speechSynthesis) return;
  speechSynthesis.cancel();
  const utt = new SpeechSynthesisUtterance(text);
  utt.rate = 0.9; utt.lang = 'en-US';
  utt.onend = () => document.getElementById('ai-speak-bars').style.display='none';
  speechSynthesis.speak(utt);
}

async function aiNextQuestion() {
  const answer = document.getElementById('ai-answer-input').value.trim();
  if (!answer) { alert('Please type your answer before continuing.'); return; }
  const q = aiQuestions[aiCurrentQ];
  // Evaluate in background
  try {
    const evalData = await fetch('/api/ai-evaluate-answer', {method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({question:q.question||q.question_text, answer, job_role:sessionData.job_role, expected_keywords:q.expected_keywords||[]})}).then(r=>r.json());
    aiTranscript.push({question:q.question||q.question_text, answer, score:evalData.score||5, feedback:evalData.feedback||''});
  } catch(e) {
    aiTranscript.push({question:q.question||q.question_text, answer, score:5, feedback:''});
  }
  aiCurrentQ++;
  if (aiCurrentQ >= aiQuestions.length) { submitInterview('ai_complete'); }
  else { displayAIQuestion(); }
}

// ‚îÄ‚îÄ Submit ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function submitInterview(reason='manual') {
  clearInterval(timerInterval);
  clearInterval(faceCheckInterval);
  clearInterval(deviceCheckInterval);
  speechSynthesis?.cancel();
  document.getElementById('submitting-overlay').style.display='flex';

  let payload = {session_id: sessionData.id, answers, mode: sessionData.mode, job_role: sessionData.job_role};

  if (sessionData.mode === 'ai_interview') {
    // Get final AI evaluation
    try {
      const finalEval = await fetch('/api/ai-final-evaluation', {method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({transcript:aiTranscript, job_role:sessionData.job_role})}).then(r=>r.json());
      payload.ai_overall_score = finalEval.overall_score || 0;
      payload.ai_feedback = finalEval;
    } catch(e) { payload.ai_overall_score=0; payload.ai_feedback={}; }
  }

  try {
    const data = await fetch('/submit-test', {method:'POST',
      headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)}).then(r=>r.json());
    if (data.success) {
      window.location.href = `interview_complete.html?session=${sessionData.id}&sub=${data.submission_id}`;
    } else {
      window.location.href = `results.html?id=${data.submission_id||0}`;
    }
  } catch(e) {
    alert('Submission failed. Please contact your recruiter.'); location.reload();
  }
}

// ‚îÄ‚îÄ Leave ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showLeaveMod() { document.getElementById('leave-modal').style.display='flex'; }
function closeLeaveMod() { document.getElementById('leave-modal').style.display='none'; }
function confirmLeave() { submitInterview('left_early'); }

// ‚îÄ‚îÄ Socket ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function initSocket() {
  socket = io(window.location.origin, {
    transports: ['polling', 'websocket'],
    withCredentials: true,
    extraHeaders: {
      'ngrok-skip-browser-warning': 'true'
    }
  });

  // FIX: Queue to hold an offer that arrives before peerConn is ready
  let pendingOffer = null;

  socket.on('connect', () => {
    socket.emit('join_room_event', {room: ROOM_CODE, role: 'candidate'});
    // FIX: Tell the recruiter we're ready so they know to send the WebRTC offer
    socket.emit('candidate_ready', {room: ROOM_CODE});
  });

  socket.on('interview_ended', ()=>{ alert('The recruiter has ended the session.'); submitInterview('recruiter_ended'); });

  // Recruiter joined ‚Üí unlock the live session
  socket.on('recruiter_joined', async () => {
    if (sessionData && sessionData.mode === 'live_recruiter') {
      const waiting = document.getElementById('recruiter-waiting');
      const active  = document.getElementById('recruiter-active');
      if (waiting) waiting.style.display = 'none';
      if (active)  active.style.display  = 'block';
      // Now start the actual session
      await startSession();
      startTimer();
      startProctoring();
    }
    // FIX: Re-announce readiness so recruiter can send offer even if they joined first
    socket.emit('candidate_ready', {room: ROOM_CODE});
  });

  // FIX: Handle WebRTC offer ‚Äî set up peer connection first, then apply offer
  socket.on('webrtc_offer', async data => {
    try {
      if (!peerConn) {
        // Store offer and set up peer connection, then apply it
        pendingOffer = data;
        await setupCandidatePeerConn();
      }
      if (pendingOffer) {
        await peerConn.setRemoteDescription(new RTCSessionDescription(pendingOffer.sdp));
        const answer = await peerConn.createAnswer();
        await peerConn.setLocalDescription(answer);
        socket.emit('webrtc_answer', {sdp: answer, room: ROOM_CODE});
        pendingOffer = null;
      }
    } catch(e) { console.error('WebRTC offer error:', e); }
  });

  socket.on('webrtc_answer', async data => {
    try { await peerConn?.setRemoteDescription(new RTCSessionDescription(data.sdp)); }
    catch(e) { console.error('WebRTC answer error:', e); }
  });

  socket.on('webrtc_ice_candidate', async data => {
    try { await peerConn?.addIceCandidate(new RTCIceCandidate(data.candidate)); }
    catch(e) { console.error('ICE candidate error:', e); }
  });

  // Recruiter text message
  socket.on('recruiter_message', data => {
    // Show a non-intrusive toast notification for recruiter messages
    if (data.message && !data.message.startsWith('[')) {
      showRecruiterMessage(data.message);
    }
  });
}

// FIX: Candidate-side peer connection setup (receives offer, sends answer)
let peerConn = null;
async function setupCandidatePeerConn() {
  if (peerConn) return;
  const iceServers = sessionData?.ice_servers || [];
  peerConn = new RTCPeerConnection({iceServers});
  // Add local camera stream to peer connection so recruiter sees candidate
  const camVideo = document.getElementById('cam-video');
  if (camVideo.srcObject) {
    camVideo.srcObject.getTracks().forEach(t => peerConn.addTrack(t, camVideo.srcObject));
  }
  peerConn.onicecandidate = e => {
    if (e.candidate) socket.emit('webrtc_ice_candidate', {candidate: e.candidate, room: ROOM_CODE});
  };
  peerConn.ontrack = e => {
    // If candidate receives recruiter's stream (optional), could show it
    console.log('Received track from recruiter');
  };
}

function showRecruiterMessage(text) {
  // Create a toast for recruiter messages
  let toast = document.getElementById('recruiter-toast');
  if (!toast) {
    toast = document.createElement('div');
    toast.id = 'recruiter-toast';
    toast.style.cssText = 'position:fixed;bottom:20px;right:20px;background:#1a2035;border:1px solid #4361ee;border-radius:12px;padding:14px 20px;max-width:320px;z-index:5000;color:#e8edf5;font-size:14px;box-shadow:0 8px 24px rgba(0,0,0,0.4);';
    document.body.appendChild(toast);
  }
  toast.innerHTML = `<div style="font-size:11px;color:#6aa3ff;font-weight:700;margin-bottom:6px;text-transform:uppercase;">üí¨ Recruiter</div>${text}`;
  toast.style.display = 'block';
  clearTimeout(toast._timeout);
  toast._timeout = setTimeout(() => { toast.style.display = 'none'; }, 8000);
}

init();
</script>
</body>
</html>