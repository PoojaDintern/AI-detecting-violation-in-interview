<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Results ‚Äî RecruitAI</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@600;700;800&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
:root{--bg:#0a0a0f;--s:#13131a;--s2:#1c1c28;--border:#2a2a3d;--accent:#6c63ff;--accent2:#a78bfa;--green:#10b981;--red:#f43f5e;--yellow:#f59e0b;--text:#e2e8f0;--muted:#64748b;}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;padding:40px 20px;}
.container{max-width:820px;margin:0 auto;}
.back-btn{display:inline-flex;align-items:center;gap:8px;padding:8px 16px;background:var(--s);border:1px solid var(--border);border-radius:8px;color:var(--muted);font-size:13px;cursor:pointer;margin-bottom:28px;text-decoration:none;transition:all .2s;}
.back-btn:hover{color:var(--text);border-color:var(--accent);}
/* HEADER CARD */
.result-header{background:var(--s);border:1px solid var(--border);border-radius:20px;padding:36px;margin-bottom:24px;text-align:center;position:relative;overflow:hidden;}
.result-header::before{content:'';position:absolute;inset:0;background:radial-gradient(ellipse at 50% 0%,rgba(108,99,255,.12) 0%,transparent 70%);}
.result-header h1{font-family:'Syne',sans-serif;font-size:30px;font-weight:800;margin-bottom:6px;position:relative;}
.candidate-info{font-size:15px;color:var(--muted);position:relative;}
.candidate-info strong{color:var(--text);}
/* SCORE CIRCLES */
.scores-row{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:24px;}
.score-card{background:var(--s);border:1px solid var(--border);border-radius:18px;padding:28px;text-align:center;}
.circle-wrap{position:relative;width:140px;height:140px;margin:0 auto 16px;}
.circle-bg{fill:none;stroke:var(--s2);stroke-width:10;}
.circle-fill{fill:none;stroke-width:10;stroke-linecap:round;transition:stroke-dashoffset 1.2s ease;transform:rotate(-90deg);transform-origin:50% 50%;}
.circle-text{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;}
.circle-val{font-family:'Syne',sans-serif;font-size:36px;font-weight:800;}
.circle-pct{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;}
.score-title{font-family:'Syne',sans-serif;font-size:16px;font-weight:700;margin-bottom:6px;}
.score-desc{font-size:13px;color:var(--muted);}
/* VERDICT */
.verdict{padding:20px 28px;border-radius:14px;text-align:center;margin-bottom:24px;font-family:'Syne',sans-serif;font-size:22px;font-weight:700;}
.verdict.passed{background:rgba(16,185,129,.1);border:1px solid rgba(16,185,129,.3);color:#6ee7b7;}
.verdict.failed{background:rgba(244,63,94,.1);border:1px solid rgba(244,63,94,.3);color:#fda4af;}
/* CARDS */
.card{background:var(--s);border:1px solid var(--border);border-radius:16px;padding:24px;margin-bottom:20px;}
.card-title{font-family:'Syne',sans-serif;font-size:17px;font-weight:700;margin-bottom:18px;display:flex;align-items:center;gap:10px;}
.info-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-bottom:8px;}
.info-box{background:var(--s2);border-radius:10px;padding:14px;text-align:center;}
.info-val{font-size:24px;font-weight:700;font-family:'Syne',sans-serif;margin-bottom:4px;}
.info-lbl{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.05em;}
/* VIOLATION BREAKDOWN */
.breakdown-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:10px;margin-bottom:16px;}
.vtype-box{background:var(--s2);border-radius:10px;padding:12px;border-left:3px solid;}
.vtype-box.low{border-left-color:var(--green);}
.vtype-box.medium{border-left-color:var(--yellow);}
.vtype-box.high{border-left-color:var(--red);}
.vtype-name{font-size:12px;font-weight:600;margin-bottom:4px;}
.vtype-count{font-size:26px;font-weight:700;color:var(--accent2);}
.vio-list{max-height:250px;overflow-y:auto;display:flex;flex-direction:column;gap:6px;}
.vio-row{display:flex;justify-content:space-between;align-items:center;padding:9px 12px;background:var(--s2);border-radius:8px;border-left:3px solid;}
.vio-row.low{border-left-color:var(--green);}
.vio-row.medium{border-left-color:var(--yellow);}
.vio-row.high{border-left-color:var(--red);}
.vio-type{font-size:13px;font-weight:500;}
.vio-time{font-size:11px;color:var(--muted);}
/* AI FEEDBACK */
.ai-summary{background:rgba(108,99,255,.06);border:1px solid rgba(108,99,255,.2);border-radius:12px;padding:18px;margin-bottom:16px;font-size:14px;line-height:1.7;color:#c4b5fd;}
.strength-list,.improve-list{display:flex;flex-direction:column;gap:6px;}
.item-row{display:flex;align-items:flex-start;gap:10px;padding:8px 12px;border-radius:8px;font-size:13px;}
.item-row.strength{background:rgba(16,185,129,.07);}
.item-row.improve{background:rgba(245,158,11,.07);}
/* BUTTONS */
.action-row{display:flex;gap:12px;margin-top:8px;flex-wrap:wrap;}
.btn{padding:13px 24px;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer;font-family:'Inter',sans-serif;transition:all .25s;border:none;}
.btn-primary{background:linear-gradient(135deg,var(--accent),#8b5cf6);color:#fff;box-shadow:0 6px 18px rgba(108,99,255,.3);}
.btn-primary:hover{transform:translateY(-2px);box-shadow:0 10px 24px rgba(108,99,255,.4);}
.btn-secondary{background:var(--s2);color:var(--text);border:1px solid var(--border);}
.btn-secondary:hover{border-color:var(--accent);color:var(--accent2);}
.btn-retake{background:rgba(16,185,129,.12);color:#6ee7b7;border:1px solid rgba(16,185,129,.3);}
.btn-retake:hover{background:rgba(16,185,129,.22);}
/* RETAKE MODAL */
.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:999;display:none;align-items:center;justify-content:center;backdrop-filter:blur(8px);}
.modal-bg.show{display:flex;}
.modal-card{background:var(--s);border:1px solid var(--border);border-radius:20px;padding:36px;max-width:460px;width:100%;}
.modal-card h2{font-family:'Syne',sans-serif;font-size:24px;margin-bottom:10px;}
.modal-card p{color:var(--muted);font-size:14px;margin-bottom:20px;line-height:1.6;}
.modal-card select{width:100%;padding:12px 14px;background:var(--s2);border:1px solid var(--border);border-radius:9px;color:var(--text);font-size:14px;font-family:'Inter',sans-serif;outline:none;margin-bottom:10px;}
.mode-mini{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:20px;}
.mm{border:2px solid var(--border);border-radius:10px;padding:12px 8px;text-align:center;cursor:pointer;font-size:12px;transition:all .2s;}
.mm:hover,.mm.sel{border-color:var(--accent);background:rgba(108,99,255,.08);}
.mm-icon{font-size:22px;margin-bottom:4px;}
.mm-lbl{font-weight:600;}
.modal-btns{display:flex;gap:10px;}
.loading{text-align:center;padding:60px;color:var(--muted);}
</style>
</head>
<body>
<div class="container">
  <a class="back-btn" href="javascript:history.back()">‚Üê Back</a>
  <div id="results-content"><div class="loading">Loading results‚Ä¶</div></div>
</div>

<!-- RETAKE MODAL -->
<div class="modal-bg" id="retake-modal">
  <div class="modal-card">
    <h2>üîÑ Retake Exam</h2>
    <p>Your credibility score will reset to <strong style="color:var(--green)">100</strong>. Fresh 10 questions will be selected for your role.</p>
    <label style="font-size:12px;color:var(--muted);text-transform:uppercase;font-weight:600;letter-spacing:.05em;display:block;margin-bottom:8px;">Job Role</label>
    <select id="retake-role"><option value="">Loading‚Ä¶</option></select>
    <label style="font-size:12px;color:var(--muted);text-transform:uppercase;font-weight:600;letter-spacing:.05em;display:block;margin-bottom:8px;">Interview Mode</label>
    <div class="mode-mini">
      <div class="mm sel" id="mm-mcq" onclick="selectRetakeMode('mcq')"><div class="mm-icon">üìù</div><div class="mm-lbl">MCQ</div></div>
      <div class="mm" id="mm-ai_interview" onclick="selectRetakeMode('ai_interview')"><div class="mm-icon">ü§ñ</div><div class="mm-lbl">AI Chat</div></div>
      <div class="mm" id="mm-live_recruiter" onclick="selectRetakeMode('live_recruiter')"><div class="mm-icon">üé•</div><div class="mm-lbl">Live</div></div>
    </div>
    <div class="modal-btns">
      <button class="btn btn-secondary" onclick="hideRetakeModal()">Cancel</button>
      <button class="btn btn-primary" onclick="startRetake()">Start Fresh Exam ‚Üí</button>
    </div>
  </div>
</div>

<script>
let currentUser=null, submissionData=null, retakeMode='mcq';

async function init() {
  const auth = await fetch('/api/check-auth').then(r=>r.json());
  if (!auth.authenticated) return window.location.href='index.html';
  currentUser = auth;
  await loadRoles();
  await loadResults();
}

async function loadRoles() {
  const data = await fetch('/api/job-roles').then(r=>r.json());
  const sel  = document.getElementById('retake-role');
  sel.innerHTML = data.roles.map(r=>`<option value="${r}">${r}</option>`).join('');
}

async function loadResults() {
  const id = new URLSearchParams(window.location.search).get('id');
  if (!id) return renderError('No submission ID in URL');
  try {
    const data = await fetch(`/api/results/${id}`).then(r=>r.json());
    if (!data.success) return renderError(data.message);
    submissionData = data;
    // Pre-select role for retake
    const sel = document.getElementById('retake-role');
    if (data.submission.job_role) {
      [...sel.options].forEach(o=>{if(o.value===data.submission.job_role)o.selected=true;});
    }
    renderResults(data);
  } catch(e) { renderError('Failed to load results: ' + e.message); }
}

function renderResults(data) {
  const sub = data.submission;
  const vios = data.violations || [];
  const breakdown = data.breakdown || {};
  const aiFeedback = data.ai_feedback || {};

  const credColor = sub.credibility_score>=80?'#10b981':sub.credibility_score>=60?'#f59e0b':'#f43f5e';
  const intColor  = sub.interview_score>=70?'#10b981':sub.interview_score>=50?'#f59e0b':'#f43f5e';

  const modeLabel = (sub.mode||'mcq').replace(/_/g,' ').replace(/\b\w/g,c=>c.toUpperCase());
  const min=Math.floor(sub.exam_duration_seconds/60), sec=sub.exam_duration_seconds%60;

  document.getElementById('results-content').innerHTML = `
    <div class="result-header">
      <h1>üìä Interview Results</h1>
      <div class="candidate-info">
        <strong>${sub.full_name||sub.username}</strong> ¬∑ ${sub.job_role} ¬∑ ${modeLabel}
        ${sub.attempt_number>1?`<span style="margin-left:8px;font-size:12px;background:rgba(108,99,255,.15);padding:2px 10px;border-radius:12px;color:var(--accent2);">Attempt #${sub.attempt_number}</span>`:''}
      </div>
    </div>

    <div class="scores-row">
      <div class="score-card">
        <div class="circle-wrap">
          <svg width="140" height="140" viewBox="0 0 140 140">
            <circle class="circle-bg" cx="70" cy="70" r="56"/>
            <circle class="circle-fill" id="cred-circle" cx="70" cy="70" r="56"
              stroke="${credColor}" stroke-dasharray="351.86" stroke-dashoffset="351.86"/>
          </svg>
          <div class="circle-text">
            <div class="circle-val" style="color:${credColor}">${sub.credibility_score}</div>
            <div class="circle-pct">/ 100</div>
          </div>
        </div>
        <div class="score-title">Credibility Score</div>
        <div class="score-desc">Behavior integrity during the exam</div>
      </div>
      <div class="score-card">
        <div class="circle-wrap">
          <svg width="140" height="140" viewBox="0 0 140 140">
            <circle class="circle-bg" cx="70" cy="70" r="56"/>
            <circle class="circle-fill" id="int-circle" cx="70" cy="70" r="56"
              stroke="${intColor}" stroke-dasharray="351.86" stroke-dashoffset="351.86"/>
          </svg>
          <div class="circle-text">
            <div class="circle-val" style="color:${intColor}">${sub.interview_score}</div>
            <div class="circle-pct">/ 100</div>
          </div>
        </div>
        <div class="score-title">Interview Score</div>
        <div class="score-desc">Technical & communication quality</div>
      </div>
    </div>

    <div class="verdict ${sub.passed?'passed':'failed'}">
      ${sub.passed?'‚úÖ PASSED ‚Äî Credibility threshold met':'‚ùå FAILED ‚Äî Credibility below threshold (60)'}
    </div>

    <div class="card">
      <div class="card-title">üìã Session Details</div>
      <div class="info-grid">
        <div class="info-box"><div class="info-val">${sub.total_violations}</div><div class="info-lbl">Violations</div></div>
        <div class="info-box"><div class="info-val">${data.gaze_events||0}</div><div class="info-lbl">Gaze Alerts</div></div>
        <div class="info-box"><div class="info-val">${data.device_alerts||0}</div><div class="info-lbl">Device Alerts</div></div>
        <div class="info-box"><div class="info-val">${min}m ${sec}s</div><div class="info-lbl">Duration</div></div>
      </div>
    </div>

    ${Object.keys(breakdown).length ? `
    <div class="card">
      <div class="card-title">‚ö†Ô∏è Violation Breakdown</div>
      <div class="breakdown-grid">
        ${Object.entries(breakdown).map(([type,count])=>{
          const sev = count<=2?'low':count<=5?'medium':'high';
          return `<div class="vtype-box ${sev}"><div class="vtype-name">${fmt(type)}</div><div class="vtype-count">${count}</div></div>`;
        }).join('')}
      </div>
      ${vios.length?`<div class="vio-list">
        ${vios.map(v=>{
          const cls = v.severity===1?'low':v.severity===2?'medium':'high';
          return `<div class="vio-row ${cls}"><span class="vio-type">${fmt(v.violation_type)}</span><span class="vio-time">${v.timestamp}</span></div>`;
        }).join('')}
      </div>`:''}
    </div>` : `<div class="card"><div class="card-title">üéâ No Violations!</div><p style="color:var(--muted)">Excellent integrity throughout the session.</p></div>`}

    ${aiFeedback.summary ? `
    <div class="card">
      <div class="card-title">ü§ñ AI Evaluation</div>
      <div class="ai-summary">${aiFeedback.summary}</div>
      ${aiFeedback.recommendation?`<div style="margin-bottom:16px;padding:12px 16px;background:rgba(108,99,255,.08);border-radius:10px;font-size:14px;font-weight:600;">Recommendation: <span style="color:var(--accent2)">${aiFeedback.recommendation}</span></div>`:''}
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
        ${aiFeedback.strengths?.length?`<div><div style="font-size:12px;color:var(--green);font-weight:700;text-transform:uppercase;margin-bottom:8px;letter-spacing:.04em;">Strengths</div><div class="strength-list">${aiFeedback.strengths.map(s=>`<div class="item-row strength">‚úÖ ${s}</div>`).join('')}</div></div>`:''}
        ${aiFeedback.improvements?.length?`<div><div style="font-size:12px;color:var(--yellow);font-weight:700;text-transform:uppercase;margin-bottom:8px;letter-spacing:.04em;">Improve</div><div class="improve-list">${aiFeedback.improvements.map(s=>`<div class="item-row improve">üìà ${s}</div>`).join('')}</div></div>`:''}
      </div>
    </div>` : ''}

    <div class="action-row">
      <button class="btn btn-primary" onclick="window.location.href='/download-report/${sub.id}'">üì• Download PDF Report</button>
      ${!currentUser.is_admin ? `<button class="btn btn-retake" onclick="showRetakeModal()">üîÑ Retake Exam (Score Resets)</button>` : ''}
      ${currentUser.is_admin ? `<button class="btn btn-secondary" onclick="window.location.href='recruiter_dashboard.html'">‚Üê Dashboard</button>` : ''}
    </div>
  `;

  // Animate circles
  requestAnimationFrame(()=>{
    animateCircle('cred-circle', sub.credibility_score);
    setTimeout(()=>animateCircle('int-circle', sub.interview_score), 200);
  });
}

function animateCircle(id, value) {
  const el = document.getElementById(id);
  if (!el) return;
  const circumference = 351.86;
  const offset = circumference - (value / 100) * circumference;
  el.style.strokeDashoffset = offset;
}

function fmt(type) {
  return (type||'').replace(/_/g,' ').replace(/\b\w/g,c=>c.toUpperCase());
}

function renderError(msg) {
  document.getElementById('results-content').innerHTML =
    `<div style="text-align:center;padding:60px;color:var(--red)"><h2>Error</h2><p style="margin-top:10px;color:var(--muted)">${msg}</p></div>`;
}

function showRetakeModal() { document.getElementById('retake-modal').classList.add('show'); }
function hideRetakeModal() { document.getElementById('retake-modal').classList.remove('show'); }

function selectRetakeMode(mode) {
  retakeMode = mode;
  ['mcq','ai_interview','live_recruiter'].forEach(m=>{
    document.getElementById('mm-'+m).classList.toggle('sel',m===mode);
  });
}

async function startRetake() {
  const role = document.getElementById('retake-role').value;
  if (!role) return alert('Please select a job role');
  const data = await fetch('/api/retake-exam',{
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({job_role: role, mode: retakeMode})
  }).then(r=>r.json());
  if (!data.success) return alert(data.message||'Error');
  window.location.href = `interview_room.html?room=${data.room_code}`;
}

init();
</script>
</body>
</html>