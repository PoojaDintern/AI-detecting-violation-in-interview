<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard ‚Äî RecruitAI</title>
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@600;700;800&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
:root{--bg:#0a0a0f;--s:#13131a;--s2:#1c1c28;--border:#2a2a3d;--accent:#6c63ff;--accent2:#a78bfa;--green:#10b981;--red:#f43f5e;--yellow:#f59e0b;--text:#e2e8f0;--muted:#64748b;}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);}
.topbar{background:var(--s);border-bottom:1px solid var(--border);padding:0 32px;height:62px;display:flex;align-items:center;justify-content:space-between;}
.brand{font-family:'Syne',sans-serif;font-size:20px;font-weight:800;background:linear-gradient(135deg,#fff,var(--accent2));background-clip:text;-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.topbar-right{display:flex;align-items:center;gap:16px;font-size:13px;color:var(--muted);}
.logout-link{padding:8px 18px;border:1px solid var(--border);border-radius:7px;color:var(--text);font-size:13px;text-decoration:none;transition:all .2s;}
.logout-link:hover{border-color:var(--accent);color:var(--accent2);}
.main{max-width:1300px;margin:0 auto;padding:32px;}
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(175px,1fr));gap:16px;margin-bottom:30px;}
.stat{background:var(--s);border:1px solid var(--border);border-radius:14px;padding:22px;position:relative;overflow:hidden;}
.stat::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;}
.stat.blue::before{background:linear-gradient(90deg,var(--accent),var(--accent2));}
.stat.green::before{background:linear-gradient(90deg,#10b981,#34d399);}
.stat.yellow::before{background:linear-gradient(90deg,#f59e0b,#fbbf24);}
.stat.red::before{background:linear-gradient(90deg,#f43f5e,#fb7185);}
.stat.purple::before{background:linear-gradient(90deg,#8b5cf6,#a78bfa);}
.stat.teal::before{background:linear-gradient(90deg,#14b8a6,#2dd4bf);}
.stat-val{font-family:'Syne',sans-serif;font-size:34px;font-weight:700;margin-bottom:4px;}
.stat-lbl{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;}
.card{background:var(--s);border:1px solid var(--border);border-radius:16px;padding:24px;margin-bottom:24px;}
.card-title{font-family:'Syne',sans-serif;font-size:17px;font-weight:700;margin-bottom:18px;padding-bottom:14px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;}
table{width:100%;border-collapse:collapse;}
th{padding:11px 14px;text-align:left;font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;border-bottom:1px solid var(--border);font-weight:600;}
td{padding:13px 14px;font-size:13px;border-bottom:1px solid rgba(42,42,61,.5);}
tr:hover td{background:rgba(108,99,255,.025);}
.badge{display:inline-block;padding:3px 10px;border-radius:20px;font-size:11px;font-weight:600;}
.bg{background:rgba(16,185,129,.12);color:#6ee7b7;}
.br{background:rgba(244,63,94,.12);color:#fda4af;}
.bb{background:rgba(108,99,255,.12);color:var(--accent2);}
.by{background:rgba(245,158,11,.12);color:#fcd34d;}
.sv-low{color:#10b981;font-weight:700;}
.sv-med{color:#f59e0b;font-weight:700;}
.sv-hi{color:#f43f5e;font-weight:700;}
.btn-sm{padding:7px 14px;border:none;border-radius:7px;font-size:12px;font-weight:600;cursor:pointer;background:rgba(108,99,255,.15);color:var(--accent2);transition:all .2s;}
.btn-sm:hover{background:rgba(108,99,255,.3);}
.vio-toast{position:fixed;top:76px;right:22px;background:var(--s);border:1px solid var(--red);border-radius:12px;padding:14px 18px;max-width:340px;z-index:999;display:none;animation:slideIn .3s ease;}
@keyframes slideIn{from{transform:translateX(360px);opacity:0}to{transform:translateX(0);opacity:1}}
.vio-toast.show{display:block;}
.empty{text-align:center;padding:40px;color:var(--muted);font-size:14px;}
.overflow{overflow-x:auto;}
</style>
</head>
<body>
<div class="topbar">
  <div class="brand">ü§ñ RecruitAI ‚Äî Admin</div>
  <div class="topbar-right">
    <span>Welcome, <strong id="admin-name">‚Ä¶</strong></span>
    <a href="/logout" class="logout-link">Logout</a>
    <a href="recruiter_dashboard.html" class="logout-link" style="color:var(--accent2);border-color:rgba(108,99,255,.4);">Recruiter Panel ‚Üí</a>
  </div>
</div>

<div class="main">
  <div class="stats">
    <div class="stat blue"><div class="stat-val" id="s-candidates">‚Äî</div><div class="stat-lbl">Candidates</div></div>
    <div class="stat green"><div class="stat-val" id="s-submissions">‚Äî</div><div class="stat-lbl">Submissions</div></div>
    <div class="stat yellow"><div class="stat-val" id="s-violations">‚Äî</div><div class="stat-lbl">Violations</div></div>
    <div class="stat red"><div class="stat-val" id="s-active">‚Äî</div><div class="stat-lbl">Active Sessions</div></div>
    <div class="stat purple"><div class="stat-val" id="s-gaze">‚Äî</div><div class="stat-lbl">Gaze Alerts</div></div>
    <div class="stat teal"><div class="stat-val" id="s-device">‚Äî</div><div class="stat-lbl">Device Alerts</div></div>
  </div>

  <div class="card">
    <div class="card-title">üìã Recent Submissions</div>
    <div class="overflow" id="submissions-container"><div class="empty">Loading‚Ä¶</div></div>
  </div>

  <div class="card">
    <div class="card-title">‚ö†Ô∏è Live Violations Feed</div>
    <div class="overflow" id="violations-container"><div class="empty">Loading‚Ä¶</div></div>
  </div>
</div>

<div class="vio-toast" id="vtoa">
  <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
    <span style="font-size:18px;">üö®</span><strong style="color:var(--red);font-size:13px;">Violation Detected</strong>
  </div>
  <div id="vtoa-msg" style="font-size:12px;color:var(--muted);"></div>
</div>

<script>
let socket;

async function init() {
  const auth=await fetch('/api/check-auth').then(r=>r.json());
  if (!auth.authenticated||!auth.is_admin) return window.location.href='index.html';
  document.getElementById('admin-name').textContent=auth.full_name||auth.username;
  await loadData();
  initSocket();
}

async function loadData() {
  const data=await fetch('/api/dashboard-stats').then(r=>r.json());
  if (!data.success) return;
  document.getElementById('s-candidates').textContent=data.stats.total_candidates;
  document.getElementById('s-submissions').textContent=data.stats.total_submissions;
  document.getElementById('s-violations').textContent=data.stats.total_violations;
  document.getElementById('s-active').textContent=data.stats.active_sessions;
  document.getElementById('s-gaze').textContent=data.stats.total_gaze_events||0;
  document.getElementById('s-device').textContent=data.stats.total_device_alerts||0;
  renderSubs(data.recent_submissions||[]);
  renderVios(data.recent_violations||[]);
}

function renderSubs(subs) {
  const el=document.getElementById('submissions-container');
  if (!subs.length){el.innerHTML='<div class="empty">No submissions yet</div>';return;}
  el.innerHTML=`<table><thead><tr><th>Candidate</th><th>Role</th><th>Mode</th><th>Credibility</th><th>Interview</th><th>Violations</th><th>Status</th><th>Attempt</th><th>Date</th><th></th></tr></thead><tbody>
  ${subs.map(s=>`<tr>
    <td><strong>${s.full_name||s.username}</strong></td>
    <td>${s.job_role||'‚Äî'}</td>
    <td><span class="badge bb">${(s.mode||'mcq').replace(/_/g,' ')}</span></td>
    <td><strong style="color:${scoreColor(s.credibility_score)}">${s.credibility_score}</strong></td>
    <td><strong>${s.interview_score||0}</strong></td>
    <td>${s.total_violations}</td>
    <td>${s.passed?'<span class="badge bg">PASSED</span>':'<span class="badge br">FAILED</span>'}</td>
    <td style="color:var(--muted)">#${s.attempt_number||1}</td>
    <td style="color:var(--muted);font-size:12px;">${s.submitted_at}</td>
    <td><button class="btn-sm" onclick="window.location.href='results.html?id=${s.id}'">Report</button></td>
  </tr>`).join('')}
  </tbody></table>`;
}

function renderVios(vios) {
  const el=document.getElementById('violations-container');
  if (!vios.length){el.innerHTML='<div class="empty">No violations</div>';return;}
  el.innerHTML=`<table id="vio-tbody-wrap"><thead><tr><th>Candidate</th><th>Violation</th><th>Severity</th><th>Time</th></tr></thead><tbody id="vio-tbody">
  ${vios.map(v=>{
    const cls=v.severity===1?'sv-low':v.severity===2?'sv-med':'sv-hi';
    const sev=v.severity===1?'Low':v.severity===2?'Medium':'High';
    return `<tr><td><strong>${v.username}</strong></td><td>${fmt(v.violation_type)}</td><td><span class="${cls}">${sev}</span></td><td>${v.timestamp}</td></tr>`;
  }).join('')}
  </tbody></table>`;
}

function scoreColor(s){return s>=80?'#10b981':s>=60?'#f59e0b':'#f43f5e';}
function fmt(t){return (t||'').replace(/_/g,' ').replace(/\b\w/g,c=>c.toUpperCase());}

function initSocket() {
  socket=io();
  socket.on('connect',()=>socket.emit('join_dashboard'));
  socket.on('violation_alert',data=>{
    document.getElementById('vtoa-msg').textContent=`${data.username} ‚Äî ${fmt(data.violation_type)} ¬∑ Score: ${data.new_credibility}`;
    const t=document.getElementById('vtoa');
    t.classList.add('show');
    setTimeout(()=>t.classList.remove('show'),5000);
    // Prepend to table
    const tbody=document.getElementById('vio-tbody');
    if (tbody) {
      const cls=data.severity===1?'sv-low':data.severity===2?'sv-med':'sv-hi';
      const sev=data.severity===1?'Low':data.severity===2?'Medium':'High';
      const row=tbody.insertRow(0);
      row.innerHTML=`<td><strong>${data.username}</strong></td><td>${fmt(data.violation_type)}</td><td><span class="${cls}">${sev}</span></td><td>${data.timestamp}</td>`;
      row.style.background='rgba(244,63,94,.06)';
      setTimeout(()=>row.style.background='',3000);
    }
    const sv=document.getElementById('s-violations');
    sv.textContent=parseInt(sv.textContent||0)+1;
  });
}

init();
</script>
</body>
</html>