<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard ‚Äî RecruitAI</title>
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700;800&family=DM+Sans:wght@300;400;500;600&family=Plus+Jakarta+Sans:wght@700;800&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0f1117;
  --bg2: #161b27;
  --s: #1a2035;
  --s2: #1e2640;
  --border: #2a3350;
  --border2: #334066;
  --accent: #4f8ef7;
  --accent2: #6aa3ff;
  --accent-light: rgba(79,142,247,0.12);
  --accent-glow: rgba(79,142,247,0.2);
  --green: #10b981;
  --red: #ef4444;
  --yellow: #f59e0b;
  --text: #e8edf5;
  --text2: #c5cde0;
  --muted: #7a88a8;
  --shadow: 0 1px 3px rgba(0,0,0,0.4), 0 4px 12px rgba(0,0,0,0.3);
  --shadow-lg: 0 4px 20px rgba(0,0,0,0.5), 0 12px 40px rgba(0,0,0,0.4);
}


*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'DM Sans', sans-serif;background:var(--bg);color:var(--text);}
.topbar{background:var(--s);border-bottom:1px solid var(--border);padding:0 32px;height:62px;display:flex;align-items:center;justify-content:space-between;}
.brand{font-family:'Plus Jakarta Sans', 'Playfair Display', sans-serif;font-size:20px;font-weight:800;background:linear-gradient(135deg,#fff,var(--accent2));background-clip:text;-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.topbar-right{display:flex;align-items:center;gap:16px;font-size:13px;color:var(--muted);}
.logout-link{padding:8px 18px;border:1px solid var(--border);border-radius:7px;color:var(--text);font-size:13px;text-decoration:none;transition:all .2s;}
.logout-link:hover{border-color:var(--accent);color:var(--accent2);}
.main{max-width:1300px;margin:0 auto;padding:32px;}
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(175px,1fr));gap:16px;margin-bottom:30px;}
.stat{background:var(--s);border:1px solid var(--border);border-radius:14px;padding:22px;position:relative;overflow:hidden;}
.stat::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;}
.stat.blue::before{background:linear-gradient(90deg,var(--accent),var(--accent2));}
.stat.green::before{background:linear-gradient(90deg,#10b981,#34d399);}
.stat.yellow::before{background:linear-gradient(90deg,#f59e0b,#fbbf24);}
.stat.red::before{background:linear-gradient(90deg,#f43f5e,#fb7185);}
.stat.purple::before{background:linear-gradient(90deg,#8b5cf6,#a78bfa);}
.stat.teal::before{background:linear-gradient(90deg,#14b8a6,#2dd4bf);}
.stat-val{font-family:'Playfair Display', serif;font-size:34px;font-weight:700;margin-bottom:4px;}
.stat-lbl{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;}
.card{background:var(--s);border:1px solid var(--border);border-radius:16px;padding:24px;margin-bottom:24px;}
.card-title{font-family:'Playfair Display', serif;font-size:17px;font-weight:700;margin-bottom:18px;padding-bottom:14px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;}
table{width:100%;border-collapse:collapse;}
th{padding:11px 14px;text-align:left;font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;border-bottom:1px solid var(--border);font-weight:600;}
td{padding:13px 14px;font-size:13px;border-bottom:1px solid rgba(42,42,61,.5);}
tr:hover td{background:rgba(13,31,60,0.025);}
.badge{display:inline-block;padding:3px 10px;border-radius:20px;font-size:11px;font-weight:600;}
.bg{background:rgba(16,185,129,.15);color:#34d399;}
.br{background:rgba(239,68,68,.15);color:#fca5a5;}
.bb{background:rgba(13,31,60,0.08);color:var(--accent2);}
.by{background:rgba(245,158,11,.15);color:#fcd34d;}
.sv-low{color:#10b981;font-weight:700;}
.sv-med{color:#f59e0b;font-weight:700;}
.sv-hi{color:#f43f5e;font-weight:700;}
.btn-sm{padding:7px 14px;border:none;border-radius:7px;font-size:12px;font-weight:600;cursor:pointer;background:rgba(79,142,247,.1);color:var(--accent2);transition:all .2s;}
.btn-sm:hover{background:rgba(13,31,60,0.2);}

.empty{text-align:center;padding:40px;color:var(--muted);font-size:14px;}
.overflow{overflow-x:auto;}


.brand { color: var(--accent); -webkit-text-fill-color: var(--accent); }
.brand-name { color: var(--text); -webkit-text-fill-color: var(--text); }



/* Subtle background texture */
body::before {
  content: '';
  position: fixed;
  inset: 0;
  background-image: radial-gradient(circle at 20% 20%, rgba(13,31,60,0.05) 0%, transparent 50%),
                    radial-gradient(circle at 80% 80%, rgba(37,99,235,0.04) 0%, transparent 50%);
  pointer-events: none;
  z-index: 0;
}

/* Cards elevated */
.card, .stat, .join-card, .result-header, .score-card, .modal-card {
  box-shadow: 0 1px 3px rgba(15,30,60,0.06), 0 4px 16px rgba(15,30,60,0.08);
  transition: box-shadow 0.2s ease;
}
.card:hover, .stat:hover {
  box-shadow: 0 2px 8px rgba(15,30,60,0.08), 0 8px 24px rgba(15,30,60,0.1);
}

/* Topbar elevated */
.topbar {
  box-shadow: 0 1px 0 var(--border), 0 2px 8px rgba(15,30,60,0.06);
  backdrop-filter: blur(10px);
}

/* Table styling */
table {
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 1px 3px rgba(15,30,60,0.06);
}

/* Stat top bar glow */
.stat.blue::before { background: linear-gradient(90deg, var(--accent), #4a6fa5); }
.stat.green::before { background: linear-gradient(90deg, var(--green), #34d399); }
.stat.yellow::before { background: linear-gradient(90deg, var(--yellow), #fbbf24); }
.stat.red::before { background: linear-gradient(90deg, var(--red), #fc8181); }
.stat.purple::before { background: linear-gradient(90deg, #7c3aed, #a78bfa); }
.stat.teal::before { background: linear-gradient(90deg, #0d9488, #2dd4bf); }

/* Proctoring sidebar brighter */
.proctoring-sidebar {
  background: var(--s);
  border-left: 1px solid var(--border);
}

/* Section titles */
.page-title, .card-title, .section-title, .join-title {
  color: var(--text);
  font-family: 'Playfair Display', serif;
}
.page-sub, .join-desc { color: var(--muted); }

/* Main wrapper bg */
.main, .container { position: relative; z-index: 1; }
.layout { position: relative; z-index: 1; }


/* Dark background with subtle gradient */
body {
  background: var(--bg);
  background-attachment: fixed;
  color: var(--text);
}

/* Subtle dark background decoration */
body::before {
  content: '';
  position: fixed;
  inset: 0;
  background-image: 
    radial-gradient(ellipse at 15% 25%, rgba(13,31,60,0.06) 0%, transparent 45%),
    radial-gradient(ellipse at 85% 75%, rgba(13,31,60,0.03) 0%, transparent 45%);
  pointer-events: none;
  z-index: 0;
}

/* Background grid - subtle on dark */




/* handled via JS scoreColor function updates */


/* Dark scrollbar */
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:var(--bg2)}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:var(--muted)}
</style>
</head>
<body>
<div class="topbar">
  <div class="brand">ü§ñ RecruitAI ‚Äî Admin</div>
  <div class="topbar-right">
    <span>Welcome, <strong id="admin-name">‚Ä¶</strong></span>
    <a href="/logout" class="logout-link">Logout</a>
    <a href="recruiter_dashboard.html" class="logout-link" style="color:var(--accent2);border-color:rgba(13,31,60,0.3);">Recruiter Panel ‚Üí</a>
  </div>
</div>

<div class="main">
  <div class="stats">
    <div class="stat blue"><div class="stat-val" id="s-candidates">‚Äî</div><div class="stat-lbl">Candidates</div></div>
    <div class="stat green"><div class="stat-val" id="s-submissions">‚Äî</div><div class="stat-lbl">Submissions</div></div>
    <div class="stat yellow"><div class="stat-val" id="s-violations">‚Äî</div><div class="stat-lbl">Violations</div></div>
    <div class="stat red"><div class="stat-val" id="s-active">‚Äî</div><div class="stat-lbl">Active Sessions</div></div>
    <div class="stat purple"><div class="stat-val" id="s-gaze">‚Äî</div><div class="stat-lbl">Gaze Alerts</div></div>
    <div class="stat teal"><div class="stat-val" id="s-device">‚Äî</div><div class="stat-lbl">Device Alerts</div></div>
  </div>

  <div class="card">
    <div class="card-title">üìã Recent Submissions</div>
    <div class="overflow" id="submissions-container"><div class="empty">Loading‚Ä¶</div></div>
  </div>

  <div class="card">
    <div class="card-title">‚ö†Ô∏è Live Violations Feed</div>
    <div class="overflow" id="violations-container"><div class="empty">Loading‚Ä¶</div></div>
  </div>
</div>

  <div id="vtoa-msg" style="font-size:12px;color:var(--muted);"></div>
</div>

<script>
let socket;

async function init() {
  const auth=await fetch('/api/check-auth').then(r=>r.json());
  if (!auth.authenticated||!auth.is_admin) return window.location.href='index.html';
  document.getElementById('admin-name').textContent=auth.full_name||auth.username;
  await loadData();
  initSocket();
}

async function loadData() {
  const data=await fetch('/api/dashboard-stats').then(r=>r.json());
  if (!data.success) return;
  document.getElementById('s-candidates').textContent=data.stats.total_candidates;
  document.getElementById('s-submissions').textContent=data.stats.total_submissions;
  document.getElementById('s-violations').textContent=data.stats.total_violations;
  document.getElementById('s-active').textContent=data.stats.active_sessions;
  document.getElementById('s-gaze').textContent=data.stats.total_gaze_events||0;
  document.getElementById('s-device').textContent=data.stats.total_device_alerts||0;
  renderSubs(data.recent_submissions||[]);
  renderVios(data.recent_violations||[]);
}

function renderSubs(subs) {
  const el=document.getElementById('submissions-container');
  if (!subs.length){el.innerHTML='<div class="empty">No submissions yet</div>';return;}
  el.innerHTML=`<table><thead><tr><th>Candidate</th><th>Role</th><th>Mode</th><th>Credibility</th><th>Interview</th><th>Violations</th><th>Status</th><th>Attempt</th><th>Date</th><th></th></tr></thead><tbody>
  ${subs.map(s=>`<tr>
    <td><strong>${s.full_name||s.username}</strong></td>
    <td>${s.job_role||'‚Äî'}</td>
    <td><span class="badge bb">${(s.mode||'mcq').replace(/_/g,' ')}</span></td>
    <td><strong style="color:${scoreColor(s.credibility_score)}">${s.credibility_score}</strong></td>
    <td><strong>${s.interview_score||0}</strong></td>
    <td>${s.total_violations}</td>
    <td>${s.passed?'<span class="badge bg">PASSED</span>':'<span class="badge br">FAILED</span>'}</td>
    <td style="color:var(--muted)">#${s.attempt_number||1}</td>
    <td style="color:var(--muted);font-size:12px;">${s.submitted_at}</td>
    <td><button class="btn-sm" onclick="window.location.href='results.html?id=${s.id}'">Report</button></td>
  </tr>`).join('')}
  </tbody></table>`;
}

function renderVios(vios) {
  const el=document.getElementById('violations-container');
  if (!vios.length){el.innerHTML='<div class="empty">No violations</div>';return;}
  el.innerHTML=`<table id="vio-tbody-wrap"><thead><tr><th>Candidate</th><th>Violation</th><th>Severity</th><th>Time</th></tr></thead><tbody id="vio-tbody">
  ${vios.map(v=>{
    const cls=v.severity===1?'sv-low':v.severity===2?'sv-med':'sv-hi';
    const sev=v.severity===1?'Low':v.severity===2?'Medium':'High';
    return `<tr><td><strong>${v.username}</strong></td><td>${fmt(v.violation_type)}</td><td><span class="${cls}">${sev}</span></td><td>${v.timestamp}</td></tr>`;
  }).join('')}
  </tbody></table>`;
}

function scoreColor(s){return s>=80?'#10b981':s>=60?'#f59e0b':'#f43f5e';}
function fmt(t){return (t||'').replace(/_/g,' ').replace(/\b\w/g,c=>c.toUpperCase());}

function initSocket() {
  socket=io();
  socket.on('connect',()=>socket.emit('join_dashboard'));
  socket.on('violation_alert',data=>{
    const t=document.getElementById('vtoa');
    // Prepend to table
    const tbody=document.getElementById('vio-tbody');
    if (tbody) {
      const cls=data.severity===1?'sv-low':data.severity===2?'sv-med':'sv-hi';
      const sev=data.severity===1?'Low':data.severity===2?'Medium':'High';
      const row=tbody.insertRow(0);
      row.innerHTML=`<td><strong>${data.username}</strong></td><td>${fmt(data.violation_type)}</td><td><span class="${cls}">${sev}</span></td><td>${data.timestamp}</td>`;
      row.style.background='rgba(244,63,94,.06)';
      setTimeout(()=>row.style.background='',3000);
    }
    const sv=document.getElementById('s-violations');
    sv.textContent=parseInt(sv.textContent||0)+1;
  });
}

init();
</script>
</body>
</html>